@using Newtonsoft.Json
@using CapaEntidad.Pedido
@using CapaEntidad.Persona
@model Ent_Liquidacion
@{
    ViewBag.Title = "Pedido";
    ViewBag.SubTitleColor = ViewBag.operacion == "Nuevo" ? "label-success" : "label-warning";
    ViewBag.SubTitle = ViewBag.operacion;
    Ent_Persona persona = new Ent_Persona();
    persona = ViewBag.infoProm;

    ViewBag._session_list_detalle_pedido = JsonConvert.SerializeObject(ViewBag._session_list_detalle_pedido, Newtonsoft.Json.Formatting.None, new JsonSerializerSettings { NullValueHandling = NullValueHandling.Ignore });

}

@*@Scripts.Render("~/bundles/bootstrap")*@
<style>
    #dwcliente {
        width: 200px;
    }

    .imgRedonda {
        width: 100px;
        height: 80px;
        border-radius: 15px;
    }

    #divImagen {
        width: 100%;
        height: 100%;
    }

    #listatallas {
        border-radius: 10px 10px 10px 10px;
        -moz-border-radius: 10px 10px 10px 10px;
        -webkit-border-radius: 10px 10px 10px 10px;
        border: 2px;
    }

    #lugar {
        border-radius: 10px 10px 10px 10px;
        -moz-border-radius: 10px 10px 10px 10px;
        -webkit-border-radius: 10px 10px 10px 10px;
        border: 2px;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        /* display: none; <- Crashes Chrome on hover */
        -webkit-appearance: none;
        margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
    }
    .btn-tabla{
        width:23px !important;        
    }

    input[type=number] {
        -moz-appearance:textfield; /* Firefox */
    }
    .w-ct{
        width :100%;
        font-weight: 600;
    }
    .table > tbody > tr > td{
        vertical-align : middle;
    }
    .precio{
        text-align:right;
    }
    .dataTables_filter {
        text-align: left !important;
    }
    .table thead{
        background-color: #e8e8e8;
    }
    .modal-pad{
        padding-bottom: 10px;
    padding-top: 10px;
    }
    /*.modal-header{
        background-color:#d33724 !important;
    }*/
    .row-p{
        padding-top: 3px;
        padding-bottom: 3px;
    }
    .overf{
        overflow-wrap:break-word;
    }
</style>
@*<link href="~/Content/plugins/iCheck/custom.css" rel="stylesheet" />
<link href="~/Content/plugins/iCheck/custom.css" rel="stylesheet" />*@

<link href="@Url.Content("~/Content/plugins/iCheck/custom.css")" rel="stylesheet" type="text/css" />

@if (ViewBag.operacion == "Nuevo")
{
    <p class="text-primary">Creando nueva liquidacion: </p>
}
else
{
    <p class="text-warning">Modificando liquidacion:  @ViewBag.IdLiquidacion</p>
}
<div class="row">
    <div class="col-md-5">
        <div class="box box-widget collapsed-box">
            <div class="box-header with-border">
                <div class="user-block">
                    <img class="img-circle" src="../Content/images/placeholder-user.jpg" alt="User Image">
                    <span class="username">@persona.Bas_Documento - @persona.NombreCompleto</span>
                    @if (String.IsNullOrEmpty(persona.premio))
                    {
                        <span class="description">@persona.Ubicacion</span>
                    }
                    else
                    {
                        <span class="description">@persona.Ubicacion<b class="pull-right text-danger"><i class="fa fa-gift"></i>&nbsp;@persona.premio</b></span>
                    }
                </div>
                <!-- /.user-block -->
                <div class="box-tools">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                <!-- /.box-tools -->
            </div>
            <div class="box-body">
                <div class="row" id="infoProm">
                    <div class="col-xs-12 col-md-12">
                        <dl class="dl-horizontal">
                            <dt>Número de documento :</dt>
                            <dd>@persona.Bas_Documento</dd>
                            <dt>Nombres y apellidos :</dt>
                            <dd>@persona.NombreCompleto</dd>
                            <dt>Asesor Comercial :</dt>
                            <dd>@persona.asesor</dd>
                            <dt>Lider :</dt>
                            <dd>@persona.Are_Descripcion</dd>
                            <dt>Ubicación :</dt>
                            <dd>@persona.Ubicacion</dd>
                            <dt>E-Mail de contacto :</dt>
                            <dd>@persona.Bas_Correo</dd>
                            <dt>Agencia :</dt>
                            <dd>@persona.bas_agencia</dd>
                            <dt>Destino :</dt>
                            <dd>@persona.bas_destino</dd>
                            <dt>Premio por ganar :</dt>
                            <dd>@persona.premio</dd>
                        </dl>
                        <input type="hidden" id="dwPromo" name="dwPromo" value="@persona.Bas_id" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="box box-widget">
            <div class="box-body">
                <label for="dwFormaPago">Formas de pago:&nbsp;<i class="glyphicon glyphicon-money"></i>&nbsp;&nbsp;</label>
                @Html.DropDownList("dwFormaPago", new SelectList(ViewBag.listFormapago, "codigo", "descripcion", "005"), new { @class = "selectpicker", @data_live_search = "false", @id = "dwFormaPago", @placeholder = ".col-xs-1" })
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="box box-widget">
            <div class="box-header with-border">
                <div class="user-block">
                    <img class="img-circle" src="../Content/images/camion.png"  alt="User Image">
                    <span class="username" id="doc-nom-persona" style="color:#f88989">Requerido la Informacion de Envio</span>

                </div>
                <!-- /.user-block -->
                <div class="box-tools">
                    <button type="button" class="btn btn-box-tool" id="btninfo" data-widget="collapse">
                        <i class="fa fa-minus" id="i_info"></i>
                    </button>
                </div>
                <!-- /.box-tools -->
            </div>
            <div class="box-body">
                <div class="row">

                    <div class="col-md-3" style="padding-left: 25px;">
                        <div id="prm" class="form-group" disabled>
                            <label for="txtagencia" style="color: #3d566e;">Tipo de Despacho</label>
                            <div class="input-group">                              
                                @Html.DropDownList("dwdespacho", new SelectList(ViewBag.despacho, "desp_cod", "desp_des", "-1"), new { @class = "selectpicker", @data_live_search = "true", @id = "dwdespacho", @name = "dwdespacho", @onchange="select_tipo();", @data_actions_box = "true", @data_selected_text_format = "count > 2" })                               
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3" id="divagencia"  style="padding-left: 25px;">
                        <div id="prm" class="form-group" disabled>
                            <label for="txtagencia" style="color: #3d566e;">Agencia</label>
                            <div class="input-group">
                                <span class="input-group-addon">
                                    <input type="checkbox" name="chkagencia" onchange="ckeck_agencia();" id="chkagencia" title="Activar o Desactivar la edicion" aria-label="Checkbox Input Group">
                                </span>
                                <input name="txtagencia" id="txtagencia" value="" maxlength="100" type="text" class="form-control" placeholder="" aria-label="Checkbox Input Group">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3" id="divdestino" style="padding-left: 25px;">
                        <div id="prm" class="form-group" disabled>
                            <label for="txtdestino" style="color: #3d566e;">Destino</label>
                            <div class="input-group">
                                <span class="input-group-addon">
                                    <input type="checkbox" onchange="ckeck_destino();" name="chkdestino" id="chkdestino" title="Activar o Desactivar la edicion" aria-label="Checkbox Input Group">
                                </span>
                                <input type="text" value="" maxlength="200" class="form-control" placeholder="" name="txtdestino" id="txtdestino" aria-label="Checkbox Input Group">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3" hidden="hidden"  id="divdireccion_agencia"  style="padding-left: 25px;visibility:hidden">
                        <div id="prm" class="form-group" disabled>
                            <label for="txtagencia_dir" style="color: #3d566e;">Direccion de Agencia</label>
                            <div class="input-group">
                                <span class="input-group-addon">
                                    <input type="checkbox" onchange="ckeck_agencia_dir();" name="chkagencia_dir" id="chkagencia_dir" title="Activar o Desactivar la edicion" aria-label="Checkbox Input Group">
                                </span>
                                <input type="text" value="" maxlength="200" class="form-control" placeholder="" name="txtagencia_dir" id="txtagencia_dir" aria-label="Checkbox Input Group">
                            </div>
                        </div>
                    </div>
                  

                    <div class="col-md-4" id="divdireccion" style="padding-left: 25px;">
                        <div id="prm" class="form-group" disabled>
                            <label for="txtdireccion" style="color: #3d566e;">Dirección</label>
                            <div class="input-group">
                                <span class="input-group-addon">
                                    <input type="checkbox" name="chkdireccion" onchange="ckeck_direccion();" id="chkdireccion" title="Activar o Desactivar la edicion" aria-label="Checkbox Input Group">
                                </span>
                                <input name="txtdireccion" id="txtdireccion" value="" maxlength="100" type="text" class="form-control" placeholder="" aria-label="Checkbox Input Group">
                                
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5" id="divreferencia" style="padding-left: 25px;">
                        <div id="prm" class="form-group" disabled>
                            <label for="txtreferencia" style="color: #3d566e;">Referencia</label>
                            <div class="input-group">
                                <span class="input-group-addon">
                                    <input type="checkbox" onchange="ckeck_referencia();" name="chkreferencia" id="chkreferencia" title="Activar o Desactivar la edicion" aria-label="Checkbox Input Group">
                                </span>
                                <input type="text" value="" maxlength="100" class="form-control" placeholder="" name="txtreferencia" id="txtreferencia" aria-label="Checkbox Input Group">
                            </div>
                        </div>
                    </div>                   
                </div>
               
               
               
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">             
        <div class="box box-widget">
            <div class="box-header with-border">
                <i class="fa fa-list"></i>&nbsp;Pedido
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="box-body">
                <div class="row">                    
                    <div class="col-xs-12 col-sm-5 col-md-3 col-lg-3">
                        <label>Articulo:</label>
                        <div class="input-group">
                            <input id="txtArticulo" type="number" min="0" step="1" maxlength="7" focus="true" placeholder="Ingrese articulo" class="form-control" />
                            <span class="input-group-btn">
                                <button class="btn btn-primary" type="submit" id="btnBuscarArticulo" name="btnConsultar" title="Buscar">
                                    <span class="glyphicon glyphicon-search"></span>
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive">
                            <table id="detPedido" class="table table-hover table-bordered dataTable">
                                <thead>
                                    <tr>                                        
                                        <th>Referencia</th>
                                        <th>Articulo</th>
                                        <th>Marca</th>
                                        <th>Color</th>
                                        <th>Talla/Cantidad</th>
                                        <th>Precio</th>
                                        <th>Comision</th>
                                        <th>Descuento</th>
                                        <th>Total</th>
                                        <th></th>
                                        <th>Lista de Articulos</th>
                                    </tr>
                                </thead>
                                <tbody data-bind="foreach:"></tbody>
                            </table>        
                        </div>
                    </div>
                </div>                       
            </div>      
            <div class="box-body">
                <div class="row">
                    <div class="col-sm-offset-5 col-sm-7 col col-md-offset-7 col-md-5">
                        <div class="row row-no-gutter">
                            <div class="col-xs-7 col-sm-5 col-md-6"><strong>Cantidades totales:</strong></div>
                            <div class="col-xs-2 col-sm-3 col-md-2 text-right"></div>
                            <div class="col-xs-3 col-sm-4 col-md-4 text-right"><span id="cantitdades">0</span></div>
                        </div>
                        <div class="row row-no-gutter">
                            <div class="col-xs-7 col-sm-5 col-md-6"><strong>Operacione Gratuitas:</strong></div>
                            <div class="col-xs-2 col-sm-3 col-md-2 text-right">S/</div>
                            <div class="col-xs-3 col-sm-4 col-md-4 text-right"><span id="opeGratuitas">0.00</span></div>
                        </div>
                        <div class="row row-no-gutter">
                            <div class="col-xs-7 col-sm-5 col-md-6"><strong>Sub Total (Sin IGV):</strong></div>
                            <div class="col-xs-2 col-sm-3 col-md-2 text-right">S/</div>
                            <div class="col-xs-3 col-sm-4 col-md-4 text-right"><span id="subTotalList">0.00</span></div>
                        </div>
                        <div class="row row-no-gutter">
                            <div class="col-xs-7 col-sm-5 col-md-6"><strong>(+) Impuestos (IGV)(18%) :</strong></div>
                            <div class="col-xs-2 col-sm-3 col-md-2 text-right">S/</div>
                            <div class="col-xs-3 col-sm-4 col-md-4 text-right"><span id="totalImpuesto">0.00</span></div>
                        </div>
                        <div class="row row-no-gutter">
                            <div class="col-xs-7 col-sm-5 col-md-6"><strong>(-)
                                @if ((int)ViewBag.CountNotas > 0)
                                {
                                    <button class="btn btn-xs btn-info" data-toggle="modal" data-target="#modalNC">Nota de Credito</button>
    }else
                                {
                                    @("Nota de Credito:");
                                }
                                </strong></div>
                               <div class="col-xs-2 col-sm-3 col-md-2 text-right">S/</div>
                            <div class="col-xs-3 col-sm-4 col-md-4 text-right"><span id="totalNota">0.00</span></div>
                        </div>
                        <div class="row row-no-gutter">
                            <div class="col-xs-7 col-sm-5 col-md-6"><strong>Total: </strong></div>
                            <div class="col-xs-2 col-sm-3 col-md-2 text-right">S/</div>
                            <div class="col-xs-3 col-sm-4 col-md-4 text-right"><span id="totalList">0.00</span></div>
                        </div>
                        <div class="row row-no-gutter">
                            <div class="col-xs-7 col-sm-5 col-md-6"><strong>(+) Percepcion :</strong></div>
                            <div class="col-xs-2 col-sm-3 col-md-2 text-right">S/</div>
                            <div class="col-xs-3 col-sm-4 col-md-4 text-right"><span id="totalPercepcion">0.00</span></div>
                        </div>
                        <br />
                        <div class="row row-no-gutter">
                            <div class="col-xs-7 col-sm-5 col-md-6"><strong>(=) Gran Total :</strong></div>
                            <div class="col-xs-2 col-sm-3 col-md-2 text-right">S/</div>
                            <div class="col-xs-3 col-sm-4 col-md-4 text-right"><strong id="grantotalList">0.00</strong></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box-footer">
                <div class="row">
                    @*<div class="col-md-12 text-left">
                        <button class="btn btn-success" type="button" id="btnliquidar" name="btnliquidar" title="Liquidar">
                            <span class="fa fa-floppy-o"></span>&nbsp;Liquidar Pedido
                        </button>
                    </div>*@
                  
                        <div class="col-md-12 text-right">

                            @*<div class="col-xs-7 col-sm-5 col-md-9">*@
                                <button class="btn btn-danger" type="button" id="btncancelar" onclick="cancelar();" name="btncancelar" title="Cancelar">
                                    <span class="glyphicon glyphicon-remove"></span>&nbsp;Cancelar Pedido
                                </button>
                            @*</div>*@

                            @*<button class="btn btn-warning" type="button" id="btnliquidar" name="btnliquidar" title="Liquidar">
                                <span class="fa fa-floppy-o"></span>&nbsp;Liquidar Pedido
                            </button>*@


                            @if (ViewBag.operacion == "Nuevo")
                            {
                                <button class="btn btn-success" type="button" id="btnliquidar" name="btnliquidar" title="Liquidar">
                                    <span class="fa fa-floppy-o"></span>&nbsp;Liquidar Pedido
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-success" type="button" id="btnliquidar" name="btnliquidar" title="Liquidar">
                                    <span class="fa fa-pencil"></span>&nbsp;Modificar Liquidacion
                                </button>
                            }

                        </div>
                    </div>  
            </div>  
        </div>
    </div>
</div>


<div class="no-margin">

</div>

@*<div class="row">
    <div class="col-md-6">
        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal2">
            Launch demo modal
        </button>
    </div>
</div>*@

<!-- Modal -->
<div class="modal fade" id="modalNC" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-primary">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h5 class="modal-title" id="myModalLabel">Seleccione Nota de Credito</h5>
            </div>
            <div class="modal-body">
                <table id="tblNC" class="table table-bordered">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Numero</th>
                            <th>Importe</th>
                        </tr>
                    </thead>
                    <tbody data-bind="foreach:"></tbody>
                    <tfoot>
                        <tr>
                            <th></th>
                            <th>Total:</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success marcar-ncs">Aceptar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" ng-app>
    <div class="modal-dialog">
        <div class="modal-content">
            <div id='myModalContent'></div>
        </div>
    </div>
</div>
<div class="modal fade" id="CRLiquidacion" tabindex="-1" role="dialog" aria-labelledby="CRLiquidacion">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div id="ifrReporte" class="well" style="width: 100%; height: 100%; padding:0;">
                            <iframe id="load" src="" frameborder="0" marginheight="1" marginwidth="1" scrolling="auto" 
                                    onload="javascript: waitingDialog.hide();" style="zoom:90%; width: 100%; height: calc(100vh - 100px); margin-bottom:0px"></iframe>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding-top: 7px; padding-bottom: 7px;">
                <a href="@Url.Action("Lista","Pedido")" class="btn btn-primary">Volver a Pedidos</a>
            </div>
        </div>
    </div>
</div>


@Html.Hidden("lblIdLiquidacion", Model.liq_Id)
@Html.Hidden("lblIdPed", Model.ped_Id)
@Html.Hidden("lblIdCust", Model.cust_Id)
@*<script src="~/Scripts/bootstrap.min.js"></script>
<script src="~/ScriptsSelect/bootstrap-select.js"></script>*@

@*<script src="~/Scripts/bootstrap-select.min.js"></script>
<script src="@Url.Content("~/Scripts/bootstrap.min.js")"></script>*@

@section scripts
{

<script src="~/Scripts/BI.js"></script>
<script src="~/Scripts/Linkend/linq.min.js"></script>
@*<script src="~/Scripts/Plugins/iCheck/icheck.min.js"></script>*@

    <script>
        var dataArray_cliente;
        $(document).ready(function () {

           dataArray_cliente = function () { return @Html.Raw(Json.Encode(ViewBag.infoProm)); }();


            $('#txtagencia').prop("disabled", true);
            $('#txtagencia_dir').prop("disabled", true);
            $('#txtdestino').prop("disabled", true);

            $('#txtdireccion').prop("disabled", true);
            $('#txtreferencia').prop("disabled", true);

            
            document.getElementById("txtagencia").className = "form-control";
            document.getElementById("txtagencia_dir").className = "form-control";
            document.getElementById("txtdestino").className = "form-control";

            document.getElementById("txtdireccion").className = "form-control";
            document.getElementById("txtreferencia").className = "form-control";

            var operacion = "@ViewBag.operacion";



            if (operacion == 'Nuevo') {
                var tip_des = dataArray_cliente.desp_cod;
                $('#dwdespacho').val((tip_des.length == 0) ? '0' : tip_des);
                $('#dwdespacho').selectpicker('refresh');

                tipo_des_defecto();

            }
            else {
                var dataArray_liq = function () { return @Html.Raw(Json.Encode(ViewBag.Liqui)); }();
                
                $('#dwdespacho').val((dataArray_liq.liq_tipo_des.length == 0) ? '0' : dataArray_liq.liq_tipo_des);
                $('#dwdespacho').selectpicker('refresh');
                var span_envio = document.getElementById("doc-nom-persona");

                //var valor = dataArray_cliente.Bas_Direccion;

                if ($('#dwdespacho').val() == '0') {

                    $("#divagencia").hide();
                    $("#divdireccion_agencia").hide();
                    $("#divdestino").hide();

                    $("#divdireccion").hide();
                    $("#divreferencia").hide();

                } else {


                    if ($('#dwdespacho').val() == '02') {
                        $('#txtagencia').val(dataArray_liq.liq_agencia);
                        $('#txtdestino').val(dataArray_liq.liq_destino);
                        $('#txtdireccion').val(dataArray_liq.liq_direccion);

                        $('#txtagencia_dir').val(dataArray_liq.liq_agencia_direccion);
                        $('#txtreferencia').val(dataArray_liq.liq_referencia);
                        span_envio.innerText = "Requerido la Informacion de Envio ";//- (Distrito - " + dataArray_cliente.lider_distrito + ")";

                    }
                    else {
                        $('#txtagencia').val(dataArray_liq.liq_agencia);
                        $('#txtdestino').val(dataArray_liq.liq_destino);
                        $('#txtdireccion').val(dataArray_liq.liq_direccion);

                        $('#txtagencia_dir').val(dataArray_liq.liq_agencia_direccion);
                        $('#txtreferencia').val(dataArray_liq.liq_referencia);

                        span_envio.innerText = "Requerido la Informacion de Envio ";// - (Distrito - " + dataArray_cliente.bas_distrito + ")";

                    }
                    if (dataArray_cliente.bas_tipo_dis == 'LC') {

                        $("#chkdireccion").prop("checked", false);
                        $('#txtdireccion').prop("disabled", true);

                        $("#chkreferencia").prop("checked", false);
                        $('#txtreferencia').prop("disabled", true);



                        var direccion = $('#txtdireccion').val().trim().trimLeft().trimRight();
                        var referencia = $('#txtreferencia').val().trim().trimLeft().trimRight();

                        if (direccion.length == 0) {
                            $("#chkdireccion").prop("checked", true);
                            $('#txtdireccion').prop("disabled", false);
                            document.getElementById("txtdireccion").className = "form-control btn-danger";
                        }

                        if (referencia.length == 0) {
                            $("#chkreferencia").prop("checked", true);
                            $('#txtreferencia').prop("disabled", false);
                            document.getElementById("txtreferencia").className = "form-control btn-danger";
                        }

                        $("#divagencia").hide();
                        $("#divdireccion_agencia").hide();
                        $("#divdestino").hide();

                        $("#divdireccion").show();
                        $("#divreferencia").show();
                    } else {

                        $("#chkagencia").prop("checked", false);
                        $('#txtagencia').prop("disabled", true);

                        $("#chkdestino").prop("checked", false);
                        $('#txtdestino').prop("disabled", true);

                        $("#chkagencia_dir").prop("checked", false);
                        $('#txtagencia_dir').prop("disabled", true);

                        var agencia = $('#txtagencia').val().trim().trimLeft().trimRight();
                        var destino = $('#txtdestino').val().trim().trimLeft().trimRight();
                        var agencia_direccion = $('#txtagencia_dir').val().trim().trimLeft().trimRight();

                        if (agencia.length == 0) {
                            $("#chkagencia").prop("checked", true);
                            $('#txtagencia').prop("disabled", false);
                            document.getElementById("txtagencia").className = "form-control btn-danger";
                        }

                        if (destino.length == 0) {
                            $("#chkdestino").prop("checked", true);
                            $('#txtdestino').prop("disabled", false);
                            document.getElementById("txtdestino").className = "form-control btn-danger";
                        }

                        if (agencia_direccion.length == 0) {
                            $("#chkagencia_dir").prop("checked", true);
                            $('#txtagencia_dir').prop("disabled", false);
                            document.getElementById("txtagencia_dir").className = "form-control btn-danger";
                        }


                        $("#divagencia").show();
                        $("#divdireccion_agencia").show();
                        $("#divdestino").show();

                        $("#divdireccion").hide();
                        $("#divreferencia").hide();
                    }
                }


            }
        });

        function tipo_des_defecto() {
            var span_envio = document.getElementById("doc-nom-persona");

            document.getElementById("txtagencia").className = "form-control";
            document.getElementById("txtagencia_dir").className = "form-control";
            document.getElementById("txtdestino").className = "form-control";

            document.getElementById("txtdireccion").className = "form-control";
            document.getElementById("txtreferencia").className = "form-control";

            //var valor = dataArray_cliente.Bas_Direccion;

            if ($('#dwdespacho').val() == '0') {

                $("#divagencia").hide();
                $("#divdireccion_agencia").hide();
                $("#divdestino").hide();

                $("#divdireccion").hide();
                $("#divreferencia").hide();

            } else {


                if ($('#dwdespacho').val() == '02') {
                    $('#txtagencia').val(dataArray_cliente.lider_agencia);
                    $('#txtdestino').val(dataArray_cliente.lider_agencia_direccion);
                    $('#txtdireccion').val(dataArray_cliente.lider_destino);

                    $('#txtagencia_dir').val(dataArray_cliente.lider_direccion);
                    $('#txtreferencia').val(dataArray_cliente.lider_referencia);
                    span_envio.innerText = "Requerido la Informacion de Envio " ;//- (Distrito - " + dataArray_cliente.lider_distrito + ")";

                }
                else {
                    $('#txtagencia').val(dataArray_cliente.bas_agencia);
                    $('#txtdestino').val(dataArray_cliente.bas_destino);
                    $('#txtdireccion').val(dataArray_cliente.Bas_Direccion);

                    $('#txtagencia_dir').val(dataArray_cliente.bas_agencia_direccion);
                    $('#txtreferencia').val(dataArray_cliente.bas_referencia);

                    span_envio.innerText = "Requerido la Informacion de Envio ";// - (Distrito - " + dataArray_cliente.bas_distrito + ")";

                }
                if (dataArray_cliente.bas_tipo_dis == 'LC') {

                    $("#chkdireccion").prop("checked", false);
                    $('#txtdireccion').prop("disabled", true);

                    $("#chkreferencia").prop("checked", false);
                    $('#txtreferencia').prop("disabled", true);

                    var direccion = $('#txtdireccion').val().trim().trimLeft().trimRight();
                    var referencia = $('#txtreferencia').val().trim().trimLeft().trimRight();

                    if (direccion.length == 0) {
                        $("#chkdireccion").prop("checked", true);
                        $('#txtdireccion').prop("disabled", false);
                        document.getElementById("txtdireccion").className = "form-control btn-danger";
                    }

                    if (referencia.length == 0) {
                        $("#chkreferencia").prop("checked", true);
                        $('#txtreferencia').prop("disabled", false);
                        document.getElementById("txtreferencia").className = "form-control btn-danger";

                    }

                    $("#divagencia").hide();
                    $("#divdireccion_agencia").hide();
                    $("#divdestino").hide();

                    $("#divdireccion").show();
                    $("#divreferencia").show();
                } else {

                    $("#chkagencia").prop("checked", false);
                    $('#txtagencia').prop("disabled", true);

                    $("#chkdestino").prop("checked", false);
                    $('#txtdestino').prop("disabled", true);

                    $("#chkagencia_dir").prop("checked", false);
                    $('#txtagencia_dir').prop("disabled", true);

                    var agencia = $('#txtagencia').val().trim().trimLeft().trimRight();
                    var destino = $('#txtdestino').val().trim().trimLeft().trimRight();
                    var agencia_direccion = $('#txtagencia_dir').val().trim().trimLeft().trimRight();

                    if (agencia.length == 0) {
                        $("#chkagencia").prop("checked", true);
                        $('#txtagencia').prop("disabled", false);
                        document.getElementById("txtagencia").className = "form-control btn-danger";
                    }

                    if (destino.length == 0) {
                        $("#chkdestino").prop("checked", true);
                        $('#txtdestino').prop("disabled", false);
                        document.getElementById("txtdestino").className = "form-control btn-danger";
                    }

                    if (agencia_direccion.length == 0) {
                        $("#chkagencia_dir").prop("checked", true);
                        $('#txtagencia_dir').prop("disabled", false);
                        document.getElementById("txtagencia_dir").className = "form-control btn-danger";
                    }


                    $("#divagencia").show();
                    $("#divdireccion_agencia").show();
                    $("#divdestino").show();

                    $("#divdireccion").hide();
                    $("#divreferencia").hide();
                }
            }



        }

        function select_tipo() {
            tipo_des_defecto();
        }

        function ckeck_agencia() {
            if ($('#chkagencia').is(':checked')) {
                $('#txtagencia').prop("disabled", false);
                $('#txtagencia').focus();
            } else {
                $('#txtagencia').prop("disabled", true);
            }
        }
        function ckeck_agencia_dir() {
            if ($('#chkagencia_dir').is(':checked')) {
                $('#txtagencia_dir').prop("disabled", false);
                $('#txtagencia_dir').focus();
            } else {
                $('#txtagencia_dir').prop("disabled", true);
            }
        }
        function ckeck_destino() {
            if ($('#chkdestino').is(':checked')) {
                $('#txtdestino').prop("disabled", false);
                $('#txtdestino').focus();
            } else {
                $('#txtdestino').prop("disabled", true);
            }
        }
        function ckeck_direccion() {
            if ($('#chkdireccion').is(':checked')) {
                $('#txtdireccion').prop("disabled", false);
                $('#txtdireccion').focus();
            } else {
                $('#txtdireccion').prop("disabled", true);
            }
        }
        function ckeck_referencia() {
            if ($('#chkreferencia').is(':checked')) {
                $('#txtreferencia').prop("disabled", false);
                $('#txtreferencia').focus();
            } else {
                $('#txtreferencia').prop("disabled", true);
            }
        }



    </script>

    <script>

        function GenerarPedido() {
            waitingDialog.show("Espere por favor...")
            $.ajax({
                type: "POST",
                url: '@Url.Action("get_valida_pedido", "Pedido")',
                data: {},
                success: function (data) {
                    waitingDialog.hide();
                    if (data.estado == 0) {
                        if (data.info.length == 0) {
                            waitingDialog.hide();
                            /*si no hay ninguna informacion en el detalle*/
                            toastr.error("No se genero la liquidacion, porque no hay detalle", "Alerta");
                            return;

                        };
                        
                        /*si en el detlla hay percepcion*/
                        var validapercep = Enumerable.from(data.info)
                          .groupBy(
                          null,
                          null,
                          "{ _ap_percepcion: $._ap_percepcion}",
                          "'' + $._ap_percepcion"
                          ).toArray();

                        if (validapercep.length >= 2) {
                            waitingDialog.hide();
                            toastr.error("No se guardo el pedido, porque en el detalle hay articulo sin percepcion", "Alerta");
                            return;
                        }

                        if (data.valida_descuento == "1") {
                            waitingDialog.hide();
                            toastr.error("Error en el descuento de la promocion, por favor consulte los precios de los articulo.", "Alerta");
                            return;
                        }

                        if (data.prom == "1") {
                            waitingDialog.hide();
                            toastr.error("No se genero la liquidacion, por favor revise las condicion de uso en la promocion utilizada", "Alerta");
                            return;
                        }
                        if (data.user == "0") {
                            waitingDialog.hide();
                            toastr.error("No se genero la liquidacion, porque hubo un problema en los datos del cliente.. por favor vuelva a intentarlo o reinicie su session:", "Alerta");
                            return;
                        }

                        if (data.stk.disponible=="1")
                        {
                            waitingDialog.hide();
                            toastr.error("No se genero la liquidacion, porque no hay suficiente stock en el producto: " + data.stk.articulo + " Talla: " + data.stk.talla, "Alerta");
                            return;
                        }
                        
                      
                        //if (valida == 0) {
                            grabar_liquidacion();
                        //}
                        
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {              
                    toastr.error("Error al consultar.", "Alerta");
                }
            });            
        }

        function cancelar() {

            //ValidarPedido();

            window.location.href = '@Url.Action("Lista", "Pedido")';

            //var firstName = '<%=Session["_session_list_detalle_pedido"]%>';

            //var session = '<%= HttpContext.Current.Session["_session_list_detalle_pedido"] %>';
            @*var productId = "@(Session["Tienda"] == null ? null : Session["Tienda"])";

            var data = function () { return @Html.Raw(Json.Encode(ViewBag.detalle_pedido)); }();*@

        }
    </script>
    <script>
        var nPreWF = 0;
        var tablaProcessing = true;
        $(document).ready(function () {
            //waitingDialog.show("Espere por favor...")
            $("#dwFormaPago").change(function () {
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("udateTipoPago", "Pedido")',
                    data: { tipoPago: $(this).val() },
                    success: function (data) {
                        //waitingDialog.hide();
                        if (data.estado == 0) {
                            $('#detPedido').DataTable().ajax.reload(function () {
                                waitingDialog.hide();
                            });
                        } else {
                            waitingDialog.hide()
                            toastr.error(data.mensaje, 'Error');
                        }
                    },
                    error: function (xhr) {
                        waitingDialog.hide();
                        toastr.error(xhr, 'Mensaje');
                    }
                });
            });
            $("#txtArticulo").keyup(function (event) {
                if (event.keyCode === 13) {
                    event.preventDefault();
                    $("#btnBuscarArticulo").click();
                }
            });
            $("#tblNC").DataTable({
                "dom": 't',
                "language": {
                    "url": "../Scripts/DataTables/Spanish.json",
                },
                "ordering": false,
                "bServerSide": true,
                "autoWidth": false,
                "bdestroy": true,
                "sAjaxSource": '@Url.Action("getPedidoNC", "Pedido")',
                "columns": [
                    /*
                             a.Consumido,
                             a.Activado,
                             a.Ncredito,
                             a.Importe,
                             a.Rhv_return_nro,
                             a.Fecha_documento
                    */
                    {
                        render: function (data, type, full) {
                            if (full.Consumido == true) {
                                return "<div class='checkbox' style='height: 13px;'><label><input style='margin-top: 0px;' name='chkNC' value='" + full.Ncredito + "' class='marcar-nc' data-ncid='" + full.Ncredito + "' type='checkbox' checked></label></div>"
                            } else {
                                return "<div class='checkbox' style='height: 13px;'><label><input style='margin-top: 0px;' name='chkNC' value='" + full.Ncredito + "' class='marcar-nc' data-ncid='" + full.Ncredito + "' type='checkbox'  ></label></div>"
                            }
                        }, "className": "content-center-text"
                    },
                    {
                        render: function (data, type, full) {
                            return full.Ncredito;
                        },
                    },
                    {
                        render: function (data, type, full) {
                            return "S/ " + full.Importe.toFixed(2);
                        }, "className": "content-rigth-text"
                    },
                ]
            });
            /**/
            $('.marcar-ncs').click(function () {
                waitingDialog.show("Espere por favor...")
                var ncs = [];
                $.each($("input[name='chkNC']:checked"), function () {
                    ncs.push($(this).val());
                });
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("MarcarNC", "Pedido")',
                    data: { ncs: ncs },
                    success: function (data) {
                        //waitingDialog.hide();
                        if (data.estado == 1) {
                            $('#modalNC').modal('hide');
                            tablaProcessing = false;
                            toastr.success(data.mensaje, 'Mensaje');
                            $('#detPedido').DataTable().ajax.reload(function () {
                                waitingDialog.hide();
                            });
                        } else {
                            waitingDialog.hide()
                            toastr.error(data.mensaje, 'Error');
                        }
                    },
                    error: function (xhr) {
                        waitingDialog.hide();
                        toastr.error(xhr, 'Mensaje');
                    }
                });
            });
            /** Carga de lista de pedidos **/

            $('#detPedido').on('processing.dt', function (e, settings, processing) {
                if (tablaProcessing) {
                    if (processing) {
                        nPreWF++;
                        if (nPreWF == 1) {
                            waitingDialog.show("Espere por favor...")
                        }
                    } else {
                        waitingDialog.hide();
                        nPreWF = 0;
                        tablaProcessing = true;
                    }
                }
            }).DataTable({
                "dom": 't<"row"<"col-md-6"f><"col-md-6"p>>',
                "language": {
                    "url": "../Scripts/DataTables/Spanish.json",
                },
                "responsive": {
                    details: false
                },
                "bServerSide": true,
                "autoWidth": false,
                "sAjaxSource": '@Url.Action("getListaDetPedido", "Pedido")',
                "fnServerData": function (sSource, aoData, fnCallback) {
                    $.getJSON(sSource, aoData, function (json) {
                        var header = json.header;
                        $("#cantitdades").html(header._qtys);


                        $("#opeGratuitas").html(header._subTotalOPG.toFixed(2));
                        $("#subTotalList").html(header._subTotalDesc.toFixed(2));
                        $("#totalImpuesto").html(header._taxesDesc.toFixed(2));
                        $("#totalNota").html(header._mtoncredito.toFixed(2));
                        $("#totalList").html(header._grandTotal.toFixed(2));
                        $("#totalPercepcion").html(header._percepcion.toFixed(2));
                        $("#grantotalList").html(header._mtopercepcion.toFixed(2));
                        fnCallback(json)
                    });
                },
                "bdestroy": true,
                //"bFilter": true,
                "start": 0,
                //"bPaginate": false,
                "ordering": false,
                "bDeferRender": true,
                "columns": [
                       { "data": "_code", "className": "desktop tablet" },
                       { "data": "_artName", "className": "desktop tablet" },
                       { "data": "_brand", "className": "desktop tablet" },
                       { "data": "_color", "className": "desktop tablet" },
                       {
                           "render": function (data, type, full) {
                               var totalC = 0;
                               var tallas = '<tr>\
                                            <td><span class="btn btn-default btn-xs w-ct">Tallas:</span></td>';
                               var cants = '<tr>\
                                            <td><span class="btn btn-default btn-xs w-ct">Cantidad:</span></td>';
                               for (var i = 0; i < full._tallas.length; i++) {
                                   tallas += '<td><span class="btn btn-default btn-xs w-ct">' + full._tallas[i] + '</td>'
                                   cants += '<td><span class="btn btn-default btn-xs w-ct">' + parseInt(full._qtys[i]) + '</td>'
                                   totalC += parseInt(full._qtys[i]);
                               }
                               tallas += '<td><span class="btn btn-success btn-xs w-ct">Total</span></td>\
                                        </tr>'
                               cants += '<td><span class="btn btn-success btn-xs w-ct">' + totalC + '</span></td></td>'
                               return "<table>" + tallas + cants + "</table>"
                           }, "className": "desktop tablet"
                       },
                       {
                           render: function (data, type, full) {
                               return "S/ " + full._price.toFixed(2);
                           }, "className": "desktop tablet precio"
                       },
                       {
                           render: function (data, type, full) {
                               return "S/ " + full._commission.toFixed(2);
                           }, "className": "desktop tablet precio"
                       },
                       {
                           render: function (data, type, full) {
                               return "S/ " + full._dscto.toFixed(2);
                           }, "className": "desktop tablet precio"
                       },
                       {
                           render: function (data, type, full) {
                               return "S/ " + full._lineTotDesc.toFixed(2);
                           }, "className": "desktop tablet precio"
                       },
                       {
                           "render": function (data, type, full) {
                               return '<div style="height:100%; vertical-align:central">\
                                <button title="Editar" class="btn btn-xs btn-default btn-tabla editar-fila" data-size="' + full._tallas + '" data-articulo="' + full._code + '" data-qty="' + full._qtys + '" data-modal="" data-toggle="modal"><span class="fa fa-pencil text-success"></span></button>\
                                <button title="Ver detalle" class="btn btn-xs btn-default btn-tabla ver-info" data-size="' + full._tallas + '" data-articulo="' + full._code + '" data-qty="' + full._qtys + '" data-modal="" data-toggle="modal"><span class="fa fa-info text-primary"></span></button>\
                                <button title="Eliminar detalle" class="btn btn-xs btn-default btn-tabla eliminar-fila" data-size="' + full._tallas + '" data-articulo="' + full._code + '" data-modal="" data-toggle="modal"><span class="fa fa-remove text-danger"></span></button>\
                            </div>';
                           }, "className": "desktop tablet"
                       },
                        {
                            "render": function (data, type, full) {
                                var totalC = 0;
                                var tallas = '<tr>\
                                            <td><span class="btn btn-default btn-xs w-ct">Tallas:</span></td>';
                                var cants = '<tr>\
                                            <td><span class="btn btn-default btn-xs w-ct">Cantidad:</span></td>';
                                for (var i = 0; i < full._tallas.length; i++) {
                                    tallas += '<td><span class="btn btn-default btn-xs w-ct">' + full._tallas[i] + '</td>'
                                    cants += '<td><span class="btn btn-default btn-xs w-ct">' + parseInt(full._qtys[i]) + '</td>'
                                    totalC += parseInt(full._qtys[i]);
                                }
                                tallas += '<td><span class="btn btn-success btn-xs w-ct">Total</span></td>\
                                        </tr>'
                                cants += '<td><span class="btn btn-success btn-xs w-ct">' + totalC + '</span></td></td>'
                                var tallcant = "<table>" + tallas + cants + "</table>"


                                var html = '<div class="row row-no-gutters">\
                                            <div class=col-xs-12>\
                                                <div class="row row-no-gutters">\
                                                    <div class="col-xs-12"><p>' + full._code + ' - ' + full._artName + '</p></div>\
                                                </div>\
                                                <div class="row row-no-gutters">\
                                                    <div class="col-xs-4">\
                                                        <div class="row">\
                                                            <div class="col-xs-12">\
                                                                <img class="img-responsive img-thumbnail" alt="Imagen Usuario" src="' + full._uriPhoto + '" />\
                                                            </div>\
                                                            <div class="col-xs-12 text-center">\
                                                                 <button title="Editar" class="btn btn-xs btn-default btn-tabla editar-fila" data-size="' + full._tallas + '" data-articulo="' + full._code + '" data-qty="' + full._qtys + '" data-modal="" data-toggle="modal"><span class="fa fa-pencil text-success"></span></button>\
                                                                <button title="Ver detalle" class="btn btn-xs btn-default btn-tabla ver-info" data-size="' + full._tallas + '" data-articulo="' + full._code + '" data-qty="' + full._qtys + '" data-modal="" data-toggle="modal"><span class="fa fa-info text-primary"></span></button>\
                                                                <button title="Eliminar detalle" class="btn btn-xs btn-default btn-tabla eliminar-fila" data-size="' + full._tallas + '" data-articulo="' + full._code + '" data-modal="" data-toggle="modal"><span class="fa fa-remove text-danger"></span></button>\
                                                            </div>\
                                                        </div>\
                                                    </div>\
                                                    <div class="col-xs-8">\
                                                        <div class="row row-no-gutters">\
                                                            <div class="col-xs-4"><b>Marca: </b></div>\
                                                            <div class="col-xs-8">' + full._brand + '</div>\
                                                        </div>\
                                                        <div class="row row-no-gutters">\
                                                            <div class="col-xs-4"><b>Color: </b></div>\
                                                            <div class="col-xs-8">' + full._color + '</div>\
                                                        </div>\
                                                        </br>\
                                                        <div class="row row-no-gutters">\
                                                            <div class="col-xs-12">' + tallcant + '</div>\
                                                        </div>\
                                                    </div>\
                                                </div>\
                                                <div class="row row-no-gutters">\
                                                    <div class="col-xs-12 full-width">\
                                                        <table class="table table-condensed table-bordered no-margin">\
                                                            <thead>\
                                                                <tr>\
                                                                    <th>Precio</th>\
                                                                    <th>Comision</th>\
                                                                    <th>Descuento</th>\
                                                                    <th>Total</th>\
                                                                </tr>\
                                                            </thead>\
                                                            <tbody>\
                                                                <tr>\
                                                                    <td>' + "S/ " + full._price.toFixed(2) + '</td>\
                                                                    <td>' + "S/ " + full._commission.toFixed(2) + '</td>\
                                                                    <td>' + "S/ " + full._dscto.toFixed(2) + '</td>\
                                                                    <td>' + "S/ " + full._lineTotDesc.toFixed(2) + '</td>\
                                                                </tr>\
                                                            </tbody>\
                                                        </table>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                        </div>'
                                return html;
                            }, "className": "mobile"
                        }
                ]
            });
            $("#btnBuscarArticulo").click(function () {

                MostrarArticulo();
            });
            $('#detPedido').on('click', '.eliminar-fila', function (e) {
                var articulo = $(this).attr('data-articulo');
                var size = $(this).attr('data-size');
                swal({
                    title: "Quitar articulo?",
                    text: "¿Desea eliminar el articulo " + articulo + ", en talla " + size + "?",
                    icon: "warning",
                    buttons: ["No", "Yes"],
                    dangerMode: true,
                })
               .then((cambiar) => {
                   if (cambiar) {
                       waitingDialog.show("Espere por favor...")
                       $.ajax({
                           type: "Post",
                           url: '@Url.Action("eliminarFilePedido", "Pedido")',
                           data: { articulo: articulo, size: size },
                           success: function (data) {
                               //waitingDialog.hide();
                               if (data.estado == 0) {
                                   tablaProcessing = false;
                                   $('#detPedido').DataTable().ajax.reload(function () {
                                       waitingDialog.hide();
                                   });
                                   toastr.success("Articulo quitado de la lista", 'Mensaje');
                               } else {
                                   toastr.error(data.mensaje, 'Error');
                                   waitingDialog.hide();
                               }
                           },
                           error: function (xhr) {
                               waitingDialog.hide();
                               toastr.error(xhr, 'Mensaje');
                           }
                       });
                   }
               });
            });
            $('#detPedido').on('click', '.editar-fila', function (e) {
                var articulo = $(this).attr('data-articulo');
                var size = $(this).attr('data-size');
                var qty = $(this).attr('data-qty');
                DibujarMostrarArticulo(articulo, size, qty);
            });
            $('#detPedido').on('click', '.ver-info', function (e) {
                var articulo = $(this).attr('data-articulo');
                var size = $(this).attr('data-size');
                var qty = $(this).attr('data-qty');
                DibujarDetalleArticulo(articulo);
            });
        })

        function grabar_liquidacion() {

            var tipo_des = $('#dwdespacho').val();
            var direccion = $('#txtdireccion').val().trim().trimLeft().trimRight();
            var referencia = $('#txtreferencia').val().trim().trimLeft().trimRight();
            var agencia = $('#txtagencia').val().trim().trimLeft().trimRight();
            var destino = $('#txtdestino').val().trim().trimLeft().trimRight();
            var agencia_direccion = $('#txtagencia_dir').val().trim().trimLeft().trimRight();


            /*condicion para enviar los datos tipo_des*/
            /*01	Despacho Independiente
              02	Despacho a Lider*/
            var liq_tipo_prov = '';
            var liq_provincia = '';
            //if (tipo_des == '01') {
                liq_tipo_prov = dataArray_cliente.bas_tipo_dis;
                liq_provincia = dataArray_cliente.bas_provincia;
            //} else {
            //    liq_tipo_prov = dataArray_cliente.bas_tipo_dis;
            //    liq_provincia = dataArray_cliente.lider_provincia;
            //}


            swal({
                title: "Liquidar pedido?",
                text: "¿Desea realizar la separacion de este pedido?",
                icon: "warning",
                buttons: ["No", "Si"],
                dangerMode: true,
            })
           .then((cambiar) => {
               if (cambiar) {
                   waitingDialog.show("Espere por favor...")
                   $.ajax({
                       type: "Post",
                       url: '@Url.Action("LiquidarPedido", "Pedido")',
                       data: { tipo_des: tipo_des, agencia: agencia, destino: destino, direccion_agencia: agencia_direccion, direccion: direccion, referencia: referencia, liq_tipo_prov: liq_tipo_prov, liq_provincia: liq_provincia },
                       success: function (data) {
                           waitingDialog.hide();
                           if ((data.Success).toString() == "true") {

                               if (gEstado == "1") {
                                   toastr.success("Se liquidó el pedido con éxito. Nro: " + data.Message + ".", "Mensaje");
                                 
                               }

                               if (gEstado == "2") {
                                   toastr.success("Se modifico la liquidació con éxito. Nro: " + data.Message + ".", "Mensaje");

                               }
                               $("#load").attr("src", "../AspNetForms/ReportLiquidation.aspx");
                               $("#CRLiquidacion").modal({ backdrop: 'static', keyboard: false });


                           } else {
                               toastr.error(data.Message, "Error");
                           }

                           //toastr.success("Liquidacion generada con exito.", 'Mensaje');
                           //$('#load').show();
                           //$("#load").attr("src", "../AspNetForms/ReportLiquidation.aspx");
                           //$("#CRLiquidacion").modal({ backdrop: 'static', keyboard: false });
                           //if (data.estado == 0) {


                           //} else {
                           //    toastr.error(data.mensaje, 'Error');
                           //}
                       },
                       error: function (xhr) {
                           waitingDialog.hide();
                           toastr.error(xhr, 'Mensaje');
                       }
                   });
               }
           });
        }

        $("#btnliquidar").click(function () {

            /*validar datos adicionales para el envio de productos*/
            var tipo_des = $('#dwdespacho').val();
            if (tipo_des == '0') {
                toastr.error('Seleccione el tipo de despacho', 'Mensaje');
                $('#dwdespacho').focus();
                return;
            }
            /*si la condicion es lima-callao entonces esta activa las casillas de la condicion*/
            if (dataArray_cliente.bas_tipo_dis == 'LC') {
                var direccion = $('#txtdireccion').val().trim().trimLeft().trimRight();
                var referencia = $('#txtreferencia').val().trim().trimLeft().trimRight();

                if (direccion.length == 0) {
                    $("#chkdireccion").prop("checked", true);
                    $('#txtdireccion').prop("disabled", false);
                    toastr.error('Ingrese la direccion del despacho', 'Mensaje');
                    $('#txtdireccion').focus();
                    return;
                }

                if (referencia.length == 0) {
                    $("#chkreferencia").prop("checked", true);
                    $('#txtreferencia').prop("disabled", false);
                    toastr.error('Ingrese la referencia del despacho', 'Mensaje');
                    $('#txtreferencia').focus();
                    return;
                }
            } else {
                var agencia = $('#txtagencia').val().trim().trimLeft().trimRight();
                var destino = $('#txtdestino').val().trim().trimLeft().trimRight();
                var agencia_direccion = $('#txtagencia_dir').val().trim().trimLeft().trimRight();

                if (agencia.length == 0) {
                    $("#chkagencia").prop("checked", true);
                    $('#txtagencia').prop("disabled", false);
                    toastr.error('Ingrese la Agencia del despacho', 'Mensaje');
                    $('#txtagencia').focus();
                    return;
                }

                if (destino.length == 0) {
                    $("#chkdestino").prop("checked", true);
                    $('#txtdestino').prop("disabled", false);
                    toastr.error('Ingrese el destino del despacho', 'Mensaje');
                    $('#txtdestino').focus();
                    return;
                }

                //if (agencia_direccion.length == 0) {
                //    $("#chkagencia_dir").prop("checked", true);
                //    $('#txtagencia_dir').prop("disabled", false);
                //    toastr.error('Ingrese la direccion de la agencia del despacho', 'Mensaje');
                //    $('#txtagencia_dir').focus();
                //    return;
                //}
            }

            var prov = '';
            var lider_bas_tipo_dis = '';
            if (tipo_des == '01') {
                prov = dataArray_cliente.bas_provincia;
                if (prov.length == 0) {
                    toastr.error('El cliente no tiene provincia, por favor actualize su provincia', 'Mensaje');
                    return;
                }
            }
            else {
                prov = dataArray_cliente.lider_provincia;
                 if (prov.length == 0) {
                    toastr.error('El Lider del cliente no tiene provincia, por favor actualize la provincia del lider', 'Mensaje');
                    return;
                }
            }

            GenerarPedido();


        });
        var gTipoDoc = '';
        var gTipoPer = '';
        var listArticulos = [];
        var glistOtderDtlTem = [];
        var glistOtderDtl = [];
        var glistPago = [];
        var gArtBusqueda
        var glistTalla = [];
        var gStyleMovile = ''
        var gbMovile = false;
        var gMontoPercepcion = 0.00;
        var gLiqId = "";
        var gPedId = "";
        var gCustId = "";
        var gEstado = "1";
        var gvalorTotalCredito = 0.00;
        var gTotal = 0.00;

        var gCustomer = {
            comision: 0.00,
            idCust: 0,
            commission_POS_visaUnica: 0.00,
            percepcion: 0.00,
            taxRate: 0.00,
            email: "",
            nombrecompleto: "",
            premio: "",
            aplica_percepcion: "0",
            cant_nota: 0
        }

        var gPedido = {
            subTotal: 0.00,
            Igv: 0.00,
            Total: 0.00,
            Percepcion: 00
        }

        //$(document).ready(function () {

        //if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        //    gStyleMovile = 'style="display:none"';
        //    gbMovile = true;
        //    ocultarDivFast('alogo');
        //}

        //buscarPersonaPedido();
        //document.getElementById("txtArticulo").focus();
        ////DibujarGrilla();

        //var iniIdLiquidacion = $('#lblIdLiquidacion').val();

        //if (iniIdLiquidacion != '') {

        //    gPedId = $('#lblIdPed').val();
        //    gCustId = $('#lblIdCust').val();
        //    gEstado = '2';
        //    //document.getElementById('lblEstado').innerHTML = 'Edición';
        //    getLiquidacion(iniIdLiquidacion);
        //}
        //});

        function setearComboSelectpicker(nameControl, valor, bloqueo) {

            $('select[name=' + nameControl + ']').val(valor);
            $('select[name=' + nameControl + ']').change();
        }

        function buscarPersonaPedido() {

            waitingDialog.show('Espere un momento por favor');
            var ControllerUrl = "@Url.Action("PersonaPedido", "Pedido")";

            var strBoton = '<button class="btn btn-primary" style="margin-top:0px;margin-bottom:0px;padding-top:0px;padding-bottom:0px;padding-right:0px;padding-left:0px;" onclick="ListarNotaCredito()" id="btnliquidar" name="btnliquidar" title="Liquidar"><span class="glyphicon glyphicon-floppy-search"></span>&nbsp;Nota de Credito</button>'
            var promotor = $('#dwPromo').val();
            if (gCustId != '') {

                promotor = 'gCustId'
            }

            document.getElementById("notaBusca").innerHTML = '&nbsp;<i class="fa fa-info-circle"></i>&nbsp;<b>Nota de Credito:</b>'
            //alert(promotor)
            $.ajax({
                type: "GET",
                url: ControllerUrl,
                contentType: "application/json; charset=utf-8",
                data: { basId: promotor },
                datatype: "json",
                cache: true,
                success: function (data) {
                    waitingDialog.hide();
                    var codTienda = ''
                    var consTienda = ''

                    if (data != '' && data != '[]') {

                        gCustomer.comision = data.comision;
                        gCustomer.idCust = data.idCust;
                        gCustomer.commission_POS_visaUnica = data.commission_POS_visaUnica;
                        gCustomer.percepcion = data.percepcion;
                        gCustomer.taxRate = data.taxRate;
                        gCustomer.email = data.email;
                        gCustomer.nombrecompleto = data.nombrecompleto;
                        gCustomer.premio = data.premio;
                        gCustomer.aplica_percepcion = data.aplica_percepcion;
                        gCustomer.cant_nota = parseInt(data.cant_nota);
                        gCustomer.premio = data.premio;
                        //document.getElementById('lblPremio').innerHTML = data.premio;


                        if (parseInt(data.cant_nota) > 0) {

                            document.getElementById("notaBusca").innerHTML = '&nbsp;<i class="fa fa-info-circle"></i>&nbsp;<b>' + strBoton + '&nbsp;:</b>';
                        }

                    }

                },
                error: function () {
                    waitingDialog.hide();
                    alert('Error buscar persona pedido')
                }

            });
            waitingDialog.hide();
        }

        function QuitarEspacios(valor) {

            valor = valor.replace(/^\s+|\s+$/g, "");

            return valor;
        }



        function MostrarArticulo() {
            var codArticulo = $('#txtArticulo').val();
            codArticulo = codArticulo.replace(/^\s+|\s+$/g, "");
            if (codArticulo != "") {

                if (codArticulo.length == 7) {
                    DibujarMostrarArticulo(codArticulo);
                    //$('#txtArticulo').val('');

                }
                else {
                    toastr.error("El codigo ingresado debe de tener 7 digitos.", "Aviso");
                }

            } else {
                toastr.error("Debe ingresar un codigo.", "Aviso");
            }
        }



        function EditarDetalle(control) {
            var codArticulo = $(control).attr('data-id');
            DibujarMostrarArticulo(codArticulo);
        }


        function DibujarMostrarArticulo(codArticulo, size, qty) {

            waitingDialog.show('Espere un momento por favor');

            var bExiste = VerificarExistencia(codArticulo);

            var ControllerUrl = "@Url.Action("listarStr_ArticuloTalla", "Pedido")";
            var css = 'class="row"'
            var border2 = 'padding: 5px 5px 5px 5px;border:2px'
            var espacio = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
            var ConstTalla = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-white btn-xs" style="width:100%;">variableTalla</button></div></td>'
            var BotonSuma = '<button title="Sumar Cantidad" class="btnSuma btn btn-success" onclick="sumarCantidad(this)" data-id="IdArticuloTallaS" data-modal="Sstock" data-toggle="modal"><span class="glyphicon glyphicon-plus"></span></button>'
            var BotonResta = '<button title="Restar Cantidad" class="btnResta btn btn-danger" onclick="restarCantidad(this)" data-id="IdArticuloTallaR" data-modal="Rstock" data-toggle="modal"><span class="glyphicon glyphicon-minus"></span></button>'
            var InputCantidadTalla = '<input id="inpArtTalla" type="Text"  name="Talla" value="valor" placeholder="cantidad" onchange = "validarStock(this)" data-id="inpStock" style="width:100%;" autofocus="" class="form-control"/>'
            var input_grup = '<div class="input-group col-xs-12 col-sm-7">\
                        <span class="input-group-btn"><button title="Restar Cantidad" class="btnResta btn btn-danger" onclick="restarCantidad(this)" data-id="IdArticuloTallaR" data-modal="Rstock" data-toggle="modal"><span class="glyphicon glyphicon-minus"></span></button></span>\
                        <input id="inpArtTalla" type="Text"  name="Talla" value="valor" placeholder="cantidad" onchange = "validarStock(this)" data-id="inpStock" style="width:100%;" autofocus="" class="form-control"/>\
                        <span class="input-group-btn"><button title="Sumar Cantidad" class="btnSuma btn btn-success" onclick="sumarCantidad(this)" data-id="IdArticuloTallaS" data-modal="Sstock" data-toggle="modal"><span class="glyphicon glyphicon-plus"></span></button></span>\
                        </div>';
            var ConstHtmlTienda = '<div id="lugar" style="background:#FFFFFF;' + border2 + '" ><div ' + css + '  style="background:#FFFFFF;" ><div class="col-sm-12"><div><h4><strong>VariableTienda</strong></h4><p>&nbsp;DireccionTienda</p></div>' + input_grup + '</div></div></div><br/>';
            var ConstCantidad = ''
            var listTalla = '';
            var listCantidad = '';
            var divFinal = '';
            var strUrlImagen = '';
            var options = { "backdrop": "static", keyboard: true };

            $.ajax({
                type: "GET",
                url: ControllerUrl,
                contentType: "application/json; charset=utf-8",
                data: { codArticulo: codArticulo },
                datatype: "json",
                cache: true,
                success: function (data) {

                    var codTienda = ''
                    var consTienda = ''

                    if (data.articulo.Art_id == null) {
                        waitingDialog.hide();
                        toastr.error("El codigo de articulo no existe", "Aviso");
                        return;
                    }

                    if (data.tallas.length == 0) {
                        waitingDialog.hide();
                        toastr.error("El codigo de articulo no tiene stock disponible", "Aviso");
                        return;
                    }

                    if (data.articulo.Art_Pre_Sin_Igv == 0) {
                        waitingDialog.hide();
                        toastr.error("El Codigo de articulo no tiene precio", "Aviso");
                        return;
                    }


                    if (data != '' && data != '[]') {
                        var infoART = data.articulo;
                        var infoTallas = data.tallas;
                        //var valors = JSON.parse(data);
                        //gArtBusqueda = valors;
                        var nombreTienda = '';
                        var urlImagenSusti = '';
                        var DireccionTienda = '';
                        var CodTalla = '';
                        var cantidad = '';
                        var afecPercep = '';
                        var NombreArticulo = '';
                        var MarcaArticulo = '';
                        var ColorArticulo = '';
                        var CategoriArticulo = '';
                        var PrecioSinIgv = '';
                        var stock = '';
                        var Ofe_Id = '';
                        var Ofe_MaxPares = '';
                        var Ofe_Porc = '';
                        var Ofe_tipo = '';
                        var Ofe_ArtVenta = '';

                        strUrlImagen = infoART.Art_Foto
                        afecPercep = infoART.Afec_Percepcion
                        NombreArticulo = infoART.Art_Descripcion
                        MarcaArticulo = infoART.Mar_Descripcion
                        ColorArticulo = infoART.Col_Descripcion
                        PrecioSinIgv = infoART.Art_Pre_Sin_Igv
                        CategoriArticulo = infoART.Cat_Pri_Descripcion + ' > ' + infoART.Cat_Descripcion

                        $.each(infoTallas, function (index, item) {
                            CodTalla = item.Tal_Descripcion
                            codTienda = item.Tall_Des;
                            _qtyTalla = 0;
                            if (size != null) {
                                if (!size.includes(CodTalla)) {
                                    return true;
                                }
                                else {
                                    _qtyTalla = qty.split(",")[size.split(",").indexOf(CodTalla.toString())];
                                }
                            }
                            nombreTienda = '<i class="fa fa-check-circle"></i>&nbsp;Talla:&nbsp;&nbsp;' + item.Tall_Des
                            DireccionTienda = '<i class="fa fa-info-circle"></i>&nbsp;Stock:&nbsp;&nbsp;' + item.Tall_Cant
                            stock = item.Tall_Cant;

                            var strhtml = ConstHtmlTienda;

                            strhtml = strhtml.replace("VariableTienda", nombreTienda);
                            strhtml = strhtml.replace("DireccionTienda", DireccionTienda);
                            strhtml = strhtml.replace("IdArticuloTallaS", CodTalla);
                            strhtml = strhtml.replace("IdArticuloTallaR", CodTalla);
                            strhtml = strhtml.replace("Rstock", stock);
                            strhtml = strhtml.replace("Sstock", stock);
                            strhtml = strhtml.replace("inpStock", stock);

                            var strValor = _qtyTalla;

                            strhtml = strhtml.replace("valor", strValor);
                            strhtml = strhtml.replace("inpArtTalla", "inpt_" + CodTalla);
                            divFinal += strhtml;

                        });

                        var strhtml = ''
                        var pOcu = "ocultarDivFast('tdImagen');mostrarDivFast('bverP'); ocultarDivFast('bocuP')"
                        var pVer = "mostrarDivFast('tdImagen');ocultarDivFast('bverP'); mostrarDivFast('bocuP')"

                        strhtml += '<div class="modal-header modal-pad">'
                        strhtml += '<button type="button" class="close text-danger" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                        strhtml += '<p style="font-size: 14.5px;" class="modal-title text-red text-bold" id="myModalLabel">Articulo:&nbsp;&nbsp;' + codArticulo + '&nbsp;&nbsp;-&nbsp;&nbsp;Precio:&nbsp;&nbsp;S/&nbsp;&nbsp;' + PrecioSinIgv + '</p>'
                        //strhtml += '<table style="border-bottom:0px;font-size:14px;width:100%;">'
                        //strhtml += '<tr>'
                        ////strhtml += '<td style="font-size:14px;width:5%;text-align:left;">'
                        ////strhtml += '<span id="bocuP" onclick ="' + pOcu + '"  class="glyphicon glyphicon-eye-close"></span>'
                        ////strhtml += '<span id="bverP" onclick ="' + pVer + '" style="display:none" class="glyphicon glyphicon-picture"></span>'
                        ////strhtml += '</td>'
                        //strhtml += '<td style="font-size:14px;width:90%;text-align:left;" class="text-red text-bold">Articulo:&nbsp;&nbsp;' + codArticulo + '&nbsp;&nbsp;-&nbsp;&nbsp;Precio:&nbsp;&nbsp;S/&nbsp;&nbsp;' + PrecioSinIgv + '</td>'
                        //strhtml += '</tr>'
                        //strhtml += '</table>'
                        //strhtml += '</h5>'
                        strhtml += '</div>'
                        strhtml += '<div class="modal-body">'
                        strhtml += '<table id="example" class="table table-hover dataTable table-striped table-responsive">'
                        strhtml += '<tbody>'
                        strhtml += '<tr>'
                        strhtml += '<td Id="tdImagen"style="vertical-align:middle;border: 1px solid;border-color:gainsboro" class="col-xs-5 col-md-4">'
                        strhtml += '<div Id="DivgImagen">'
                        strhtml += '<div id="DivNombre" style="text-align:center;"><h5><b class="text-primary">' + NombreArticulo + '</b></h5></div><br/>'
                        strhtml += '<div id="DivImagen" style="text-align:center;">'
                        strhtml += '<img id="imagenCatalogo" class="imgRedonda" src="' + strUrlImagen + '" width="100%" height="100%" />'
                        strhtml += '</div><br/>'
                        //strhtml += '<div id="DivPrecio" style="text-align:left"><table style="width:100%" ><tr><td style="width:50%" ><div style="width:100%" ><h5><b>Precio:&nbsp;&nbsp;</b></h5></div></td><td><div style="width:100%;color:#FF0000"><h5><b>S/&nbsp;&nbsp;' + PrecioSinIgv + '</b></h5></div></td></tr></table></div>'

                        strhtml += '<div id="DivPrecio" class="row row-p">\
                                    <div class="col-xs-5">Precio:</div>\
                                    <div class="col-xs-7"><strong class="text-red">S/&nbsp;&nbsp;' + PrecioSinIgv + '</strong></div>\
                                </div>';
                        //strhtml += '<div id="DivMarca" style="text-align:left"><h5><b>Marca:&nbsp;&nbsp;</b>' + MarcaArticulo + '</h5></div>'
                        strhtml += '<div id="DivPrecio" class="row row-p">\
                                    <div class="col-xs-12 col-sm-5"><strong>Marca:</strong></div>\
                                    <div class="col-xs-12 col-sm-7"><span class="overf">' + MarcaArticulo + '</span></div>\
                                </div>';
                        //strhtml += '<div id="DivColor" style="text-align:left"><h5><b>Color:&nbsp;&nbsp;</b>' + ColorArticulo + '</h5></div>'
                        strhtml += '<div id="DivPrecio" class="row row-p">\
                                    <div class="col-xs-12 col-sm-5"><strong>Color:</strong></div>\
                                    <div class="col-xs-12 col-sm-7"><span class="overf">' + ColorArticulo + '</span></div>\
                                </div>';
                        strhtml += '<div id="DivCateg" style="text-align:left"><h5><b>Categorización:</b></h5></div>'

                        strhtml += '<div id="DivHCodArt"  style="display:none;">' + codArticulo + '</div>'
                        strhtml += '<div id="DivHAfecPerc"  style="display:none;">' + afecPercep + '</div>'
                        strhtml += '<div id="DivHDesArt"  style="display:none;">' + NombreArticulo + '</div>'
                        strhtml += '<div id="DivHMarArt"  style="display:none;">' + MarcaArticulo + '</div>'
                        strhtml += '<div id="DivHColArt"  style="display:none;">' + ColorArticulo + '</div>'
                        strhtml += '<div id="DivHPrecioArt"  style="display:none;">' + PrecioSinIgv + '</div>'
                        strhtml += '<div id="DivHImagenArt"  style="display:none;">' + strUrlImagen + '</div>'
                        strhtml += '<div id="DivHOfe_tipo"  style="display:none;">' + Ofe_tipo + '</div>'
                        strhtml += '<div id="DivHOfe_Id"  style="display:none;">' + Ofe_Id + '</div>'
                        strhtml += '<div id="DivHOfe_MaxPares"  style="display:none;">' + Ofe_MaxPares + '</div>'
                        strhtml += '<div id="DivHOfe_Porc"  style="display:none;">' + Ofe_Porc + '</div>'
                        strhtml += '<div id="DivHOfe_ArtVenta"  style="display:none;">' + Ofe_ArtVenta + '</div>'

                        strhtml += '</div>'
                        strhtml += '</td>'
                        strhtml += '<td class="col-xs-7 col-sm-8">'
                        strhtml += '<div id="listTalla" style="overflow-x: hidden; overflow-y:auto; height: 378px;">'
                        strhtml += divFinal
                        strhtml += '</div>'
                        strhtml += '</td>'
                        strhtml += '</tr>'
                        strhtml += '</tbody>'
                        strhtml += '</table>'
                        strhtml += '</div>'
                        strhtml += '<div class="modal-footer modal-pad">'
                        strhtml += '<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>'
                        strhtml += '<input type="button" class="btn btn-success" onclick="agregarLista(' + (size == null ? null : 1) + ')"   value="Agregar" />'
                        strhtml += '</div>'

                        $('#myModalContent').html(strhtml);
                        $('#myModal').modal(options);
                        $('#myModal').modal('show');
                        $('#myModal').on('shown.bs.modal', function (event) {
                            waitingDialog.hide();
                        })
                        //
                    } else {
                        toastr.error("Stock por ingresar.", "Aviso");
                        waitingDialog.hide();
                    }
                },
                error: function () {
                    waitingDialog.hide();
                    alert('Error DibujarMostrarArticulo')
                }
            });
            //waitingDialog.hide();
        }

        function sumarCantidad(control) {

            var Cod = control.getAttribute('data-id');
            var stock = parseInt(control.getAttribute('data-modal'));
            var cInput = 'inpt_' + Cod;
            var valor = $('#' + cInput).val();
            var valorInt = 0;
            var msjAlert = "";
            valorInt = ((BorrarEspacio(valor) == '') ? (msjAlert += 'Fecha Nacimiento.<br/>', 1) : parseInt(valor) + 1);
            valorInt = ((valorInt >= stock) ? (stock) : valorInt);

            $('#' + cInput).val(valorInt);
        }

        function agregarLista(editar) {

            if (validarAgregarLista()) {
                var LinecantTotal = 0;
                var listTallasCantidad = []; //lista de las tallas escogidas
                $('input[name="Talla"]').each(function () {

                    var valor = QuitarEspacios($(this).val());
                    var CantTalla = ((valor == '') ? 0 : parseInt(valor));

                    if (CantTalla > 0 || (CantTalla == 0 && editar != null)) {

                        LinecantTotal += CantTalla;
                        var codTalla = $(this).attr("id").substr(5);
                        var cantStock = parseInt($(this).attr("data-id"));

                        var oTalla = {
                            Ofe_tipo: null,
                            Ofe_Id: null,
                            Ofe_MaxPares: null,
                            Ofe_Porc: null,
                            Ofe_ArtVenta: null,
                            codTalla: codTalla,
                            CantTalla: CantTalla,
                            stockTalla: null,
                            comisionTalla: null,
                            descuentoTalla: null,
                            totalTalla: null
                        }
                        listTallasCantidad.push(oTalla);
                    }
                });

                //if (LinecantTotal > 0) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("setDetallePedido", "Pedido")',
                    //contentType: "application/json; charset=utf-8",
                    data: { listTallasCantidad: listTallasCantidad, editar: (editar == null ? false : true), tipoPago: $("#dwFormaPago").val() },
                    //dataType: "json",
                    success: function (data) {
                        tablaProcessing = false;
                        toastr.success("Se agrego el Articulo a la venta.", 'Mensaje');
                        $('#detPedido').DataTable().ajax.reload();
                        $('#myModal').modal('hide')
                        // validarOferta();
                    },
                    error: function (xhr) {
                        waitingDialog.hide();
                        toastr.error(xhr, 'Mensaje');
                    }
                });
                //}
            } else {
                toastr.error("* Verificar las cantidades Ingresadas. <br/> * Debe ingresar cantidades mayor a cero.", "Error");
            }
        }

        //VALIDACION DE LAS OFERTAS
        function validarOferta() {

            var porcComision = gCustomer.comision / 100;
            var listArticulosOfertaPorcentaje = listArticulos.filter(obj => obj.Ofe_tipo === 'N'); //lista de articulos con ofertas tipo desc Porcentaje
            var listArticulosOfertaPack = listArticulos.filter(obj => obj.Ofe_tipo === 'P');  //lista de articulos con ofertas tipo precio Pack
            var cantOfertaPorc = listArticulosOfertaPorcentaje.length;
            var cantOfertaPack = listArticulosOfertaPack.length;

            if (cantOfertaPorc > 0) {

                listArticulosOfertaPorcentaje = listArticulosOfertaPorcentaje.sort(function (a, b) { return a.Ofe_Id - b.Ofe_Id });

                var listOfertaPorc = uniqueBy(listArticulosOfertaPorcentaje, "Ofe_Id"); //lista de ofertas porcentaje que existe

                for (var i = 0; i < listOfertaPorc.length; i++) {//recorremos oferta por oferta

                    var totalPares = 0;
                    var maxPares = 0;
                    var prcOfeDesc = 0.00
                    var tmpListOfeArt = [];

                    var listArticulosOferta = listArticulosOfertaPorcentaje.filter(obj => obj.Ofe_Id === listOfertaPorc[i]);//optenemos todos los articulos con una oferta

                    for (var j = 0; j < listArticulosOferta.length; j++) {

                        var codigoArt = listArticulosOferta[j].codigoArt;

                        var PrecioArt = listArticulosOferta[j].PrecioArt;
                        maxPares = listArticulosOferta[j].Ofe_MaxPares;
                        var listaTallas = listArticulosOferta[j].listTallas;
                        prcOfeDesc = parseFloat(listArticulosOferta[j].Ofe_Porc) / 100;
                        //console.log('ver lista')
                        //console.log(listaTallas)
                        $.each(listaTallas, function (index, item) {

                            var qty = parseInt(item.CantTalla);
                            totalPares += qty;
                            var CodTalla = item.codTalla;
                            //alert('CodTalla seteado')
                            //alert(CodTalla)
                            for (var k = 0; k < qty; k++) {

                                var objArtPromocion = {
                                    codigoArt: codigoArt,
                                    CodTalla: CodTalla,
                                    PrecioArt: PrecioArt,
                                    cantidad: 1,
                                    porc_comision: porcComision,
                                    descuento: 0,
                                    oferta: listOfertaPorc[i]
                                }
                                tmpListOfeArt.push(objArtPromocion);
                            }

                        })
                    }

                    var res = Math.floor(totalPares / maxPares);
                    //alert('res')
                    //alert(res)
                    tmpListOfeArt = tmpListOfeArt.sort(function (a, b) { return a.PrecioArt - b.PrecioArt }); //ordenamos de menor a mayor precio

                    if (res > 0) {

                        if (prcOfeDesc == 1) {
                            prcOfeDesc = 0.5;
                            res = 2;
                        }

                        var desc_oferta = 0.00;

                        for (var j = 0; j < res; ++j) {

                            var itmPrecio = tmpListOfeArt[j].PrecioArt;
                            var itmPrcCom = tmpListOfeArt[j].porc_comision;
                            var itmCant = tmpListOfeArt[j].cantidad;
                            var _com_mon = Math.round((itmPrecio * itmCant) * itmPrcCom * 100) / 100;
                            //alert(itmPrecio);
                            //alert(_com_mon);
                            //alert(prcOfeDesc);
                            var montoDesc = parseFloat(((itmPrecio * itmCant) - _com_mon) * (prcOfeDesc));
                            //alert(montoDesc)
                            //alert(montoDesc)
                            if ((j == 0 && maxPares > 0) || (maxPares == 1)) {
                                desc_oferta = redondearDecimal(montoDesc)
                            }

                            //desc_oferta = desc_oferta.toFixed(2);
                            //alert('descuento en el temporal')
                            //alert(desc_oferta)
                            //alert(tmpListOfeArt[j].codigoArt)
                            tmpListOfeArt[j].descuento = desc_oferta;
                        }

                        for (var j = 0; j < listArticulos.length; j++) {

                            var codigoArt = listArticulos[j].codigoArt;
                            var PrecioArt = listArticulos[j].PrecioArt;
                            var listTallaCantidad = listArticulos[j].listTallas;
                            var listdescuentoArticulo = tmpListOfeArt.filter(obj => obj.codigoArt === codigoArt);

                            for (var k = 0; k < listTallaCantidad.length; k++) {

                                var codTalla = listTallaCantidad[k].codTalla;
                                var CantTalla = listTallaCantidad[k].CantTalla;
                                var comisionTalla = listTallaCantidad[k].comisionTalla;
                                //alert('talla')
                                //alert(codTalla)
                                //console.log(listdescuentoArticulo)
                                var listdescuentoArtTalla = listdescuentoArticulo.filter(obj => obj.CodTalla === codTalla);
                                //alert(listdescuentoArtTalla.length)
                                var dscto = 0.00;

                                for (var l = 0; l < listdescuentoArtTalla.length; l++) {

                                    dscto += listdescuentoArtTalla[l].descuento;

                                }
                                //alert('descuento talla')
                                //alert(dscto)
                                listTallaCantidad[k].descuentoTalla = dscto;
                                var totalTalla = redondearDecimal((CantTalla * PrecioArt) - comisionTalla - dscto);
                                listTallaCantidad[k].totalTalla = listTallaCantidad[k].totalTalla - totalTalla;
                            }

                            listArticulos[j].listTallas = listTallaCantidad;

                        }

                    }

                }
            }


            //PASANDO OFERTAS TIPO PRECIO PACK
            if (cantOfertaPack > 0) {

                listArticulosOfertaPack = listArticulosOfertaPack.sort(function (a, b) { return a.Ofe_Id - b.Ofe_Id });
                //Ofe_ArtVenta
                var listOfertaPack = uniqueBy(listArticulosOfertaPack, "Ofe_Id"); //lista de ofertas pack que existe

                for (var i = 0; i < listOfertaPack.length; i++) {

                    var totalPares = 0;
                    var maxPares = 0;
                    var prcOfeDesc = 0.00
                    var tmpListOfeArt = [];
                    var ofe_PrecioPack = 0.00

                    var listArticulosOferta = listArticulosOfertaPack.filter(obj => obj.Ofe_Id === listOfertaPack[i]);


                    for (var j = 0; j < listArticulosOferta.length; j++) {

                        var codigoArt = listArticulosOferta[j].codigoArt;

                        var PrecioArt = listArticulosOferta[j].PrecioArt;
                        maxPares = listArticulosOferta[j].Ofe_MaxPares;
                        var listaTallas = listArticulosOferta[j].listTallas;
                        prcOfeDesc = parseFloat(listArticulosOferta[j].Ofe_Porc) / 100;
                        ofe_PrecioPack = listArticulosOferta[j].Ofe_ArtVenta;
                        //console.log('ver lista')
                        //console.log(listaTallas)
                        $.each(listaTallas, function (index, item) {

                            var qty = parseInt(item.CantTalla);
                            totalPares += qty;
                            var CodTalla = item.codTalla;
                            //alert('CodTalla seteado')
                            //alert(CodTalla)
                            for (var k = 0; k < qty; k++) {

                                var objArtPromocion = {
                                    codigoArt: codigoArt,
                                    CodTalla: CodTalla,
                                    PrecioArt: PrecioArt,
                                    cantidad: 1,
                                    porc_comision: porcComision,
                                    descuento: 0,
                                    oferta: listOfertaPack[i]
                                }
                                tmpListOfeArt.push(objArtPromocion);
                            }
                        })

                    }

                    var res = Math.floor(totalPares / maxPares);
                    tmpListOfeArt = tmpListOfeArt.sort(function (a, b) { return a.PrecioArt - b.PrecioArt }); //ordenamos de menor a mayor precio

                    if (res > 0) {

                        var totalpromocion = res * maxPares;
                        var desc_oferta = 0.00;

                        var cantColec = 0;
                        var montoColec = 0;

                        for (var j = 0; j < totalpromocion; ++j) {

                            var itmPrecio = tmpListOfeArt[j].PrecioArt;
                            var itmPrcCom = tmpListOfeArt[j].porc_comision;
                            var itmCant = tmpListOfeArt[j].cantidad;
                            var _com_mon = Math.round((itmPrecio * itmCant) * itmPrcCom * 100) / 100;

                            montoColec += (itmPrecio * itmCant) - _com_mon;
                            cantColec += itmCant;
                            //console.log('cantidad')
                            //console.log(cantColec)
                            //console.log(maxPares)
                            if (cantColec == maxPares) {
                                //console.log('entro')
                                //console.log(montoColec)

                                var TotalDesc = montoColec - ofe_PrecioPack;

                                for (var k = 0; k < cantColec; ++k) {

                                    var itmPrecioPk = tmpListOfeArt[j - k].PrecioArt;//precio del articulo
                                    var itmPrcComPk = tmpListOfeArt[j - k].porc_comision;//porcentaje de la comision
                                    var itmCantPk = tmpListOfeArt[j - k].cantidad;//cantidad (1)
                                    var _com_monPk = Math.round((itmPrecioPk * itmCantPk) * itmPrcComPk * 100) / 100;//comision
                                    var totallineaPk = itmPrecioPk - _com_monPk;
                                    desc_oferta = (((totallineaPk / montoColec) * TotalDesc) * 100) / 100;

                                    tmpListOfeArt[j - k].descuento = redondearDecimal(desc_oferta);

                                }

                                cantColec = 0;
                                montoColec = 0;
                                desc_oferta = 0;

                            }


                        }

                        for (var j = 0; j < listArticulos.length; j++) {

                            var codigoArt = listArticulos[j].codigoArt;
                            var PrecioArt = listArticulos[j].PrecioArt;
                            var listTallaCantidad = listArticulos[j].listTallas;
                            var listdescuentoArticulo = tmpListOfeArt.filter(obj => obj.codigoArt === codigoArt);

                            for (var k = 0; k < listTallaCantidad.length; k++) {

                                var codTalla = listTallaCantidad[k].codTalla;
                                var CantTalla = listTallaCantidad[k].CantTalla;
                                var comisionTalla = listTallaCantidad[k].comisionTalla;

                                //alert('talla')
                                //alert(codTalla)
                                //console.log(listdescuentoArticulo)
                                var listdescuentoArtTalla = listdescuentoArticulo.filter(obj => obj.CodTalla === codTalla);
                                //alert(listdescuentoArtTalla.length)
                                var dscto = 0.00;

                                for (var l = 0; l < listdescuentoArtTalla.length; l++) {

                                    dscto += listdescuentoArtTalla[l].descuento;

                                }
                                //alert('descuento talla')
                                //alert(dscto)
                                listTallaCantidad[k].descuentoTalla = dscto;
                                var totalTalla = redondearDecimal((CantTalla * PrecioArt) - comisionTalla - dscto);
                                listTallaCantidad[k].totalTalla = totalTalla;
                            }

                            listArticulos[j].listTallas = listTallaCantidad;

                        }




                    }


                }

            }


            //for (var i = 0; i < listOfertaPorcentaje.length; i++) {

            //    alert(listOfertaPorcentaje[i].codigoArt);
            //    alert(listOfertaPorcentaje[i].PrecioArt);
            //}

            //var listArticulosOfertaPack = listArticulos.filter(obj => obj.Ofe_tipo === 'P');  //lista de articulos con ofertas tipo precio Pack
            //console.log(listOfertaPack);
            //for (var i = 0; i < listOfertaPack.length; i++) {

            //    alert(listOfertaPack[i].codigoArt);
            //    alert(listOfertaPack[i].PrecioArt);
            //}

        }

        // FIN VALIDACION DE  OFERTAS
        function redondearDecimal(numero) {
            //alert('entro')
            numero = parseFloat(numero.toFixed(6));
            //alert(numero);
            numero = parseFloat(numero.toFixed(5));
            //alert(numero);
            numero = parseFloat(numero.toFixed(4));
            //alert(numero);
            numero = parseFloat(numero.toFixed(3));
            //alert(numero);
            numero = Math.round(numero * 100) / 100
            //alert('t');
            //alert(numero);
            numero = parseFloat(numero.toFixed(2));
            //alert(numero);
            //alert('termino')

            return numero
        }

        function uniqueBy(arr, prop) {
            return arr.reduce((a, d) => {
                if (!a.includes(d[prop])) { a.push(d[prop]); }
                return a;
            }, []);
        }


        function validarAgregarLista() {

            var bValido = true;
            var cantTotal = 0;
            $('input[name="Talla"]').each(function () {

                var valor = QuitarEspacios($(this).val());
                var CantTalla = ((valor == '') ? 0 : parseInt(valor));
                cantTotal += CantTalla;

                if (CantTalla >= 0) {

                    var cantStock = parseInt($(this).attr("data-id"));
                    bValido = ((CantTalla > cantStock) ? false : bValido);
                } else {

                    bValido = false;
                }

            });

            bValido = ((cantTotal <= 0) ? false : bValido);

            return bValido;
        }

        function recalcularCostosArticulos() {

            var CantidadTotal = 0;
            var subTOTAL = 0.00
            var porcComision = gCustomer.comision / 100;
            var montoTaxes = 0.00;
            var montoPercepcion = 0.00;
            var Total = 0.00;
            var GranTotal = 0.00;
            var apliPercepcion = 1;
            if (listArticulos != null) {

                for (var i = 0; i < listArticulos.length; i++) {

                    var LinecantTotal = 0;
                    var ComisionSum = 0.00;
                    var PrecioArt = listArticulos[i].PrecioArt;
                    var listTallasCantidad = listArticulos[i].listTallas;
                    var percepcion = parseInt(listArticulos[i].AfecPercep);
                    var desc = 0.00;
                    apliPercepcion = ((percepcion == 0) ? 0 : parseInt(apliPercepcion));

                    for (var j = 0; j < listTallasCantidad.length; j++) {

                        var CodTalla = listTallasCantidad[j].codTalla;
                        var Cantidad = listTallasCantidad[j].CantTalla;
                        var ComisionTalla = listTallasCantidad[j].comisionTalla;
                        var desctoTalla = listTallasCantidad[j].descuentoTalla;

                        LinecantTotal += Cantidad;
                        ComisionSum += ComisionTalla;
                        desc += desctoTalla;
                    }

                    var Comission = ComisionSum;//(((PrecioArt * LinecantTotal)) * porcComision) * 1;


                    var comiss = Math.round(Comission * 100) / 100;
                    var Total = Math.round(((PrecioArt * LinecantTotal) - comiss - desc) * 100) / 100;

                    listArticulos[i].Comission = comiss;
                    listArticulos[i].listTallas = listTallasCantidad;
                    listArticulos[i].Total = Total;
                    listArticulos[i].Comission = comiss;
                    listArticulos[i].CantidadTotal = LinecantTotal;
                    subTOTAL += Total;
                }

                subTOTAL = redondearDecimal(subTOTAL);

                var taxRate = Math.round((gCustomer.taxRate / 100) * 100) / 100;
                var Percepcion = gCustomer.percepcion;
                var AplicaPrecepcion = gCustomer.aplica_percepcion;
                montoTaxes = Math.round((subTOTAL * taxRate) * 100) / 100;
                Total = Math.round(((subTOTAL + montoTaxes) - gvalorTotalCredito) * 100) / 100;
                Total = ((Total < 0) ? 0 : Total);
                var percepcionRate = (gCustomer.aplica_percepcion) ? Math.round((gCustomer.percepcion / 100) * 100) / 100 : 0;
                montoPercepcion = Math.round(Total * percepcionRate * apliPercepcion * 100) / 100;
                GranTotal = Math.round((Total + montoPercepcion) * 100) / 100;
            }

            //alert(subTOTAL);
            //alert(montoTaxes)
            //alert(percepcionRate)
            //alert(montoPercepcion);
            gMontoPercepcion = montoPercepcion;
            gTotal = Total;
            document.getElementById("subTotalList").innerHTML = 'S/. ' + subTOTAL;
            document.getElementById("totalImpuesto").innerHTML = 'S/. ' + montoTaxes;
            document.getElementById("totalPercepcion").innerHTML = 'S/. ' + montoPercepcion;
            document.getElementById("totalNota").innerHTML = 'S/. ' + gvalorTotalCredito;

            document.getElementById("totalList").innerHTML = 'S/. ' + Total;
            document.getElementById("grantotalList").innerHTML = 'S/. ' + GranTotal;
            document.getElementById("EtiqtotalPercepcion").innerHTML = '&nbsp;<i class="fa fa-info-circle"></i>&nbsp;<b>Percepcion ' + gCustomer.percepcion + '%</b>:';

        }


        function EliminarArticuloList(codigoArticulo) {

            for (var i = 0; i < listArticulos.length; i++) {

                if (codigoArticulo == listArticulos[i].codigoArt) {
                    listArticulos.splice(i, 1);
                }
            }
        }

        function VerificarExistencia(codigoArticulo) {

            var bexiste = false;

            for (var i = 0; i < listArticulos.length; i++) {

                if (codigoArticulo == listArticulos[i].codigoArt) {
                    bexiste = true;
                    glistTalla = listArticulos[i].listTallas;

                }
            }

            return bexiste;
        }

        function VerificarExistenciabk(codigoArticulo) {


            for (var i = 0; i < listArticulos.length; i++) {

                if (codigoArticulo == listArticulos[i].codigoArt) {

                    var listTallasCantidad2 = listArticulos[i].listTallas;

                    for (var j = 0; j < listTallasCantidad2.length; j++) {

                        var CodTalla = listTallasCantidad2[j].codTalla;
                        var Cantidad = listTallasCantidad2[j].CantTalla;
                        var numero = 0;
                        numero = 3
                        //alert('inpt_' + CodTalla)
                        //$('inpt_' + CodTalla).val(Cantidad);
                        //$('#' + cInput).val(valorInt);
                        $('#inpt_06').val(numero)
                        //alert($('#inpt_06').val())

                    }
                }
            }

        }

        function VerificarArticuloTalla(codTalla) {

            var valor = '';

            for (var j = 0; j < glistTalla.length; j++) {

                var CodTalla = glistTalla[j].codTalla;
                if (codTalla == CodTalla) { valor = glistTalla[j].CantTalla; };
            }

            return valor;
        }

        function DibujarGrilla() {

            if (gbMovile) {

                GrillaMovil();

            } else {

                GrillaComputador();
            }
        }

        function GrillaComputador() {

            recalcularCostosArticulos();

            var strtable = '';
            var theader = '';
            var tbody = '';
            theader += '<thead>';
            theader += '<tr>';
            theader += '<th>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible"></label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible">Referencia</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th ' + gStyleMovile + '>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible">Articulo</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th ' + gStyleMovile + '>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible">Marca</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th ' + gStyleMovile + '>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible">Color</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th>';
            theader += '<div class="col-sm-1" style="width:100%;text-align:center;margin-top:2px;margin-bottom:2px;Text">';
            theader += '<label for="disponible">Talla/Cantidad</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th ' + gStyleMovile + '>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += ' <label for="disponible">Precio</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th ' + gStyleMovile + '>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += ' <label for="disponible">Comision</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th ' + gStyleMovile + '>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible">Descuento</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible">Total</label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible"></label>';
            theader += '</div>';
            theader += '</th>';
            theader += '<th>';
            theader += '<div class="col-sm-1" style="margin-top:2px;margin-bottom:2px;">';
            theader += '<label for="disponible"></label>';
            theader += '</div>';
            theader += '</th>';
            theader += '</tr>';
            theader += '</thead>';

            tbody += '<td>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += '<button title="Ver detalle" style="border-radius:50%" onclick="EditarDetalle(this)" class="btnEditar btn-xs btn-success" data-id="valorEdit" data-modal="" data-toggle="modal"><span class="glyphicon glyphicon-edit"></span></button>';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += 'Referencia';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td ' + gStyleMovile + '>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += 'Articulo';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td ' + gStyleMovile + '>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += 'Marca';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td ' + gStyleMovile + '>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += 'Color';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;text-align:center;">';
            tbody += '<table><tr><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-white btn-xs"  title="Tallas"  style="width:100%;">T:</button></div></td><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-success btn-xs" style="width:100%;">Total</button></div></td>ListvariableTalla</tr><tr><td><div style="margin-top:2px;margin-right:2px;"><button  title="Cantidad"  class="btn btn-white btn-xs" style="width:100%;">C:</button></div></td></td><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-success btn-xs" style="width:100%;">VTotal</button></div></td>ListvariableCantidad</tr></table>'
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td ' + gStyleMovile + '>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += 'Precio';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td ' + gStyleMovile + '>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += 'Comision';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td ' + gStyleMovile + '>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += 'Descuento';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += 'TotalM';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += ' <button title="Ver detalle" style="border-radius:50%" onclick="verDetalle(this)" class="btnEditar btn-xs btn-primary" data-id="valorBoton" data-modal="" data-toggle="modal"><span class="glyphicon glyphicon-info-sign blue"></span></button>';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '<td>';
            tbody += '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            tbody += ' <button title="Eliminar detalle" style="border-radius:50%" onclick="PopupEliminar(this)" class="btnEliminar btn-xs btn-danger" data-id="valorDelete" data-modal="" data-toggle="modal"><span class="glyphicon glyphicon-remove" "></span></button>';
            tbody += '</div>';
            tbody += '</td>';
            tbody += '</tr>';

            var Body = '';

            var ConstTalla = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-primary btn-xs"  style="width:100%;" title="Talla"  data-id="codTienda" data-tda="desTiendaS" data-modal="codTalla" data-art="codArticulo"  >variableTalla</button></div></td>'
            var ConstCantidad = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-info btn-xs" style="width:100%;text-align:center;">variableCantidad</button></div></td>'
            var listTalla = '';
            var listCantidad = '';

            if (listArticulos != null) {
                for (var i = 0; i < listArticulos.length; i++) {
                    var temrBody = tbody
                    temrBody = temrBody.replace("Referencia", listArticulos[i].codigoArt);
                    temrBody = temrBody.replace("Articulo", listArticulos[i].DescriArt);
                    temrBody = temrBody.replace("valorBoton", listArticulos[i].codigoArt);
                    temrBody = temrBody.replace("valorEdit", listArticulos[i].codigoArt);
                    temrBody = temrBody.replace("valorDelete", listArticulos[i].codigoArt);
                    temrBody = temrBody.replace("Marca", listArticulos[i].MarcaArt);
                    temrBody = temrBody.replace("Color", listArticulos[i].ColorArt);
                    temrBody = temrBody.replace("Precio", 'S/. ' + listArticulos[i].PrecioArt);
                    //temrBody = temrBody.replace("Comision", listArticulos[i].Comission);
                    //temrBody = temrBody.replace("TotalM", listArticulos[i].Total);

                    var listTallasCantidad2 = listArticulos[i].listTallas;
                    listTalla = '';
                    listCantidad = '';
                    var total = 0;
                    var comisionTotalLine = 0.00;
                    var TotalLine = 0.00;
                    var descuentoArticulo = 0.00;
                    for (var j = 0; j < listTallasCantidad2.length; j++) {

                        var talla = listTallasCantidad2[j].codTalla;
                        var cantidad = listTallasCantidad2[j].CantTalla;
                        var comisionTalla = listTallasCantidad2[j].comisionTalla;
                        var totalTalla = listTallasCantidad2[j].totalTalla;
                        var dsctoTalla = listTallasCantidad2[j].descuentoTalla;
                        //console.log('comision Talla')
                        //console.log(comisionTalla)
                        total += parseInt(cantidad);
                        descuentoArticulo += dsctoTalla;

                        listTalla += ConstTalla;
                        listCantidad += ConstCantidad;
                        //console.log('comision total ini  ')
                        //console.log(comisionTotalLine)
                        comisionTotalLine = Math.round((comisionTotalLine + comisionTalla) * 100) / 100;
                        //console.log('comision total fin  ')
                        //console.log(comisionTotalLine)
                        TotalLine = Math.round((TotalLine + totalTalla) * 100) / 100;;

                        listTalla = listTalla.replace("variableTalla", talla);
                        listCantidad = listCantidad.replace("variableCantidad", cantidad);

                    }

                    //temrBody = temrBody.replace("Descuento", listArticulos[i].Descuento);
                    temrBody = temrBody.replace("Descuento", 'S/. ' + descuentoArticulo);

                    //console.log('comision total line ')
                    //console.log(comisionTotalLine)

                    temrBody = temrBody.replace("Comision", 'S/. ' + comisionTotalLine);
                    temrBody = temrBody.replace("TotalM", 'S/. ' + TotalLine);

                    temrBody = temrBody.replace("VTotal", total);
                    temrBody = temrBody.replace("ListvariableTalla", listTalla);
                    temrBody = temrBody.replace("ListvariableCantidad", listCantidad);

                    Body += temrBody;
                }

                //for (var i = 0; i < listArticulos.length; i++) {

                //    var listTallasCantidad2 = listArticulos[i].listTallas;

                //    for (var j = 0; j < listTallasCantidad2.length; j++) {
                //        alert(listTallasCantidad2[j].codTalla)
                //        alert(listTallasCantidad2[j].CantTalla)
                //    }
                //}

                //strtable = '<table class="table table-borderer">' + theader + '<tbody>' + Body + '</tbody>' + '</table>';
            }
            //document.getElementById("divDetalleVenta").innerHTML = strtable;

        }

        function verDetalle(control) {
            var codArticulo = $(control).attr('data-id');
            DibujarDetalleArticulo(codArticulo);

        }

        function PopupEliminar(control) {
            var codArticulo = $(control).attr('data-id');

            var strhtml = ''

            strhtml += '<div class="modal-header modal-header-danger" style="margin-top:0px;margin-bottom:0px;padding-top:2px;padding-bottom:2px;">'
            strhtml += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
            strhtml += '<h5 class="modal-title" id="myModalLabel">'
            strhtml += '<table style="border-bottom:0px;font-size:14px;width:50%;">'
            strhtml += '<tr>'
            strhtml += '<td style="font-size:14px;width:100%;text-align:left;">Articulo:&nbsp;&nbsp;' + codArticulo + '</td>'
            strhtml += '</tr>'
            strhtml += '</table>'
            strhtml += '</h5>'
            strhtml += '</div>'
            strhtml += '<div class="modal-body">'
            strhtml += 'Desea eliminar al articulo: ' + codArticulo + '?'
            strhtml += '</div>'
            strhtml += '<div class="modal-footer" style="margin-top:-30px">'
            strhtml += '<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>'
            strhtml += '<button type="button" class="btn btn-danger"  onclick="EliminarDetalle(this)"  data-id="' + codArticulo + '"  data-dismiss="modal">Eliminar</button>'
            //strhtml += ' <button type="button"  title="Eliminar class="btn btn-danger" data-dismiss="modal" detalle" onclick="EliminarDetalle(this)"  data-id="' + codArticulo + '" data-modal="" data-toggle="modal">Elimninar</button>';
            //strhtml += '<input type="submit" class="btn btn-primary" onclick="agregarLista()"  id="btnSubmit" value="Agregar" />'
            strhtml += '</div>'
            var options = { "backdrop": "static", keyboard: true };

            $('#myModalContent').html(strhtml);
            $('#myModal').modal(options);
            $('#myModal').modal('show');

        }

        function ValidacionLiquidacion() {

            var bValidacion = true;
            var varLocalPercep;

            /*validacion de que no esisten ningun articulo*/

            if (listArticulos == null || listArticulos == '') {
                bValidacion = false;
                toastr.error("Debe ingresar al menos un articulo en el pedido.", "Error");
                /*fin de la validacion de que no existe articulo*/

            } else {

                for (var i = 0; i < listArticulos.length; i++) {

                    if (i == 0) { varLocalPercep = parseInt(listArticulos[i].AfecPercep) }

                    if (varLocalPercep != parseInt(listArticulos[i].AfecPercep)) {

                        toastr.error("No puede liquidar articulos con percepcion y sin percepción a la vez.", "Error");
                        bValidacion = false;
                        break;
                    }

                }
            }

            return bValidacion;
        }

        function PopupLiquidarPedido() {

            if (ValidacionLiquidacion()) {
                var strhtml = ''
                strhtml += '<div class="modal-header modal-header-danger" style="margin-top:0px;margin-bottom:0px;padding-top:2px;padding-bottom:2px;">'
                strhtml += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                strhtml += '<h5 class="modal-title" id="myModalLabel">'
                strhtml += '<table style="border-bottom:0px;font-size:14px;width:50%;">'
                strhtml += '<tr>'
                strhtml += '<td style="font-size:14px;width:100%;text-align:left;">Confirmación de Liquidación</td>'
                strhtml += '</tr>'
                strhtml += '</table>'
                strhtml += '</h5>'
                strhtml += '</div>'
                strhtml += '<div class="modal-body">'
                strhtml += 'Desea liquidar el pedido ?.'
                strhtml += '</div>'
                strhtml += '<div class="modal-footer" style="margin-top:-30px">'
                strhtml += '<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>'
                strhtml += '<button type="button" class="btn btn-primary"  onclick="liquidarPedido()"   data-dismiss="modal">Liquidar Pedido</button>'
                //strhtml += ' <button type="button"  title="Eliminar class="btn btn-danger" data-dismiss="modal" detalle" onclick="EliminarDetalle(this)"  data-id="' + codArticulo + '" data-modal="" data-toggle="modal">Elimninar</button>';
                //strhtml += '<input type="submit" class="btn btn-primary" onclick="agregarLista()"  id="btnSubmit" value="Agregar" />'
                strhtml += '</div>'
                var options = { "backdrop": "static", keyboard: true };

                $('#myModalContent').html(strhtml);
                $('#myModal').modal(options);
                $('#myModal').modal('show');
            }

        }

        function PopupEliminarTalla(control) {
            var codArticulo = $(control).attr('data-id');
            var codTalla = $(control).attr('data-modal');

            var strhtml = ''

            strhtml += '<div class="modal-header modal-header-danger" style="margin-top:0px;margin-bottom:0px;padding-top:2px;padding-bottom:2px;">'
            strhtml += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
            strhtml += '<h5 class="modal-title" id="myModalLabel">'
            strhtml += '<table style="border-bottom:0px;font-size:14px;width:50%;">'
            strhtml += '<tr>'
            strhtml += '<td style="font-size:14px;width:100%;text-align:left;">Articulo:&nbsp;&nbsp;' + codArticulo + '</td>'
            strhtml += '</tr>'
            strhtml += '</table>'
            strhtml += '</h5>'
            strhtml += '</div>'
            strhtml += '<div class="modal-body">'
            strhtml += 'Desea eliminar la talla ' + codTalla + ' del articulo: ' + codArticulo + '?'
            strhtml += '</div>'
            strhtml += '<div class="modal-footer" style="margin-top:-30px">'
            strhtml += '<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>'
            strhtml += '<button type="button" class="btn btn-danger"  onclick="EliminarDetalleTalla(this)"  data-id="' + codArticulo + '" data-talla="' + codTalla + '"  data-dismiss="modal">Eliminar</button>'
            //strhtml += ' <button type="button"  title="Eliminar class="btn btn-danger" data-dismiss="modal" detalle" onclick="EliminarDetalle(this)"  data-id="' + codArticulo + '" data-modal="" data-toggle="modal">Elimninar</button>';
            //strhtml += '<input type="submit" class="btn btn-primary" onclick="agregarLista()"  id="btnSubmit" value="Agregar" />'
            strhtml += '</div>'
            var options = { "backdrop": "static", keyboard: true };

            $('#myModalContent').html(strhtml);
            $('#myModal').modal(options);
            $('#myModal').modal('show');

        }

        function EliminarDetalle(control) {
            var codArticulo = $(control).attr('data-id');
            EliminarArticuloList(codArticulo);
            //DibujarGrilla();
            toastr.success("El articulo se elimino del pedido.", 'Mensaje');

        }

        function EliminarDetalleTalla(control) {
            var codArticulo = $(control).attr('data-id');
            var codTalla = $(control).attr('data-talla');
            EliminarArticuloTallaList(codArticulo, codTalla);
            recalcularCostosArticulos()
            //DibujarGrilla();
            toastr.success("La talla se elimino del pedido.", 'Mensaje');
        }

        function EliminarArticuloTallaList(codigoArticulo, CodTalla) {

            for (var i = 0; i < listArticulos.length; i++) {

                if (codigoArticulo == listArticulos[i].codigoArt) {

                    var listTallasCantidad2 = listArticulos[i].listTallas;

                    for (var j = 0; j < listTallasCantidad2.length; j++) {

                        if (CodTalla = listTallasCantidad2[j].codTalla) {

                            listTallasCantidad2.splice(j, 1);
                            listArticulos[i].listTallas = listTallasCantidad2;
                            break;
                        }

                    }
                    break;
                }
            }
        }

        function DibujarDetalleArticulo(codArticulo) {
            var infoART;
            var infoTallas;
            waitingDialog.show('Espere un momento por favor');
            $.ajax({
                type: "Post",
                url: '@Url.Action("listarStr_ArticuloTalla", "Pedido")',
                data: { codArticulo: codArticulo },
                success: function (data) {

                    infoART = data.articulo;
                    infoTallas = data.tallas;
                    var border2 = 'padding: 5px 5px 5px 5px;border:2px';
                    var espacio = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
                    var css = 'class="row"';
                    var ConstTalla = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-white btn-xs" style="width:100%;">variableTalla</button></div></td>'
                    var BotonSuma = '<button title="Sumar Cantidad" class="btnSuma btn btn-success" onclick="sumarCantidad(this)" data-id="IdArticuloTallaS" data-modal="Sstock" data-toggle="modal"><span class="glyphicon glyphicon-plus"></span></button>'
                    var BotonResta = '<button title="Restar Cantidad" class="btnResta btn btn-danger" onclick="restarCantidad(this)" data-id="IdArticuloTallaR" data-modal="Rstock" data-toggle="modal"><span class="glyphicon glyphicon-minus"></span></button>'
                    var InputCantidadTalla = '<input id="inpArtTalla" type="Text"  name="Talla" value="valor" placeholder="cantidad" onchange = "validarStock(this)" data-id="inpStock" style="width:100%;" autofocus="" class="form-control"/>'
                    var ConstHtmlDetalleTallas = '<br/><div id="listatallas" style="background:#FFFFFF;' + border2 + '" ><div ' + css + '  style="background:#FFFFFF;" ><div class="col-sm-12"><i class="fa fa-info-circle"></i>&nbsp;<b>Tallas y Cantidades</b><br/></div><div class="col-sm-12">ListaTallas</div><br/></div></div>';
                    var ConstHtmlDetalle = '<br/><div id="lugar" style="background:#FFFFFF;' + border2 + '" ><div ' + css + '  style="background:#FFFFFF;" ><div class="col-sm-12"><table style="width:100%">Cantidad&nbsp;Precio&nbsp;Comision&nbsp;Descuento&nbsp;Total</table></div><br/></div></div>';

                    var strTablaTallas = '<table><tr><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-white btn-xs"  title="Tallas"  style="width:100%;">Tallas:</button></div></td><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-success btn-xs" style="width:100%;">Total</button></div></td>ListvariableTalla</tr><tr><td><div style="margin-top:2px;margin-right:2px;"><button  title="Cantidad"  class="btn btn-white btn-xs" style="width:100%;">Cantidad:</button></div></td></td><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-success btn-xs" style="width:100%;">VTotal</button></div></td>ListvariableCantidad</tr></table>'
                    var ConstTalla = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-primary btn-xs"  style="width:100%;" title="Talla"  data-id="codTienda" data-tda="desTiendaS" data-modal="codTalla" data-art="codArticulo"  >variableTalla</button></div></td>'
                    var ConstCantidad = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-info btn-xs" style="width:100%;text-align:center;">variableCantidad</button></div></td>'

                    var listTalla = '';
                    var listCantidad = '';
                    var divFinal = '';
                    var strUrlImagen = '';
                    var codTienda = ''
                    var consTienda = ''
                    var Precio = 0.00;
                    var Comision = 0.00;
                    var Descuento = 0.00;
                    var Total = 0.00;
                    var urlImagenSusti = '';
                    var DireccionTienda = '';
                    var CodTalla = '';
                    var cantidad = '';

                    var NombreArticulo = '';
                    var MarcaArticulo = '';
                    var ColorArticulo = '';
                    var CategoriArticulo = '';
                    var PrecioSinIgv = '';
                    var stock = '';


                    strUrlImagen = infoART.Art_Foto
                    NombreArticulo = infoART.Art_Descripcion
                    MarcaArticulo = infoART.Mar_Descripcion
                    ColorArticulo = infoART.Col_Descripcion
                    PrecioSinIgv = infoART.Art_Pre_Sin_Igv
                    CategoriArticulo = infoART.Cat_Pri_Descripcion + ' > ' + infoART.Col_Descripcion

                    var strhtml = ConstHtmlDetalle;
                    var strhtmlTallas = ConstHtmlDetalleTallas
                    var strIni = '<tr><td><p>&nbsp;<i class="fa fa-check-circle"></i>&nbsp;<b>';
                    var strIniTotal = '<tr><td><p>&nbsp;<i class="fa fa-info-circle"></i>&nbsp;<b>';
                    var strMedio = '</b></p></td><td valign="top" style="padding:0; margin:0;text-align:right">&nbsp;&nbsp;'
                    var strFin = '</td></tr>';

                    var strCantidad = strIni + 'Cantidad:' + strMedio + infoART.CantidadTotal + strFin;
                    var strPrecio = strIni + 'Precio:' + strMedio + infoART.PrecioArt + strFin;
                    var strComision = strIni + 'Comision:' + strMedio + infoART.Comission + strFin;

                    var strTotal = strIniTotal + 'TOTAL:' + strMedio + '<b>' + infoART.Total + strFin;

                    strhtml = strhtml.replace("Cantidad", strCantidad);
                    strhtml = strhtml.replace("Precio", strPrecio);
                    strhtml = strhtml.replace("Comision", strComision);

                    strhtml = strhtml.replace("Total", strTotal);

                    var listTallasCantidad2 = infoTallas;
                    var total = 0;
                    var totalDescuento = 0.00;

                    for (var j = 0; j < listTallasCantidad2.length; j++) {

                        var talla = listTallasCantidad2[j].Tal_Descripcion;
                        var cantidad = listTallasCantidad2[j].Tall_Cant;
                        var descuen = listTallasCantidad2[j].descuentoTalla;

                        totalDescuento += descuen;
                        total += parseInt(cantidad);
                        listTalla += ConstTalla;
                        listCantidad += ConstCantidad;

                        listTalla = listTalla.replace("variableTalla", talla);
                        listCantidad = listCantidad.replace("variableCantidad", cantidad);

                    }
                    var strDescuento = strIni + 'Descuento:' + strMedio + totalDescuento + strFin;
                    strhtml = strhtml.replace("Descuento", strDescuento);

                    strTablaTallas = strTablaTallas.replace("VTotal", total);
                    strTablaTallas = strTablaTallas.replace("ListvariableTalla", listTalla);
                    strTablaTallas = strTablaTallas.replace("ListvariableCantidad", listCantidad);
                    strhtmlTallas = strhtmlTallas.replace("ListaTallas", strTablaTallas);

                    divFinal += strhtmlTallas
                    //divFinal += strhtml;

                    var strhtml = ''
                    var pOcu = "ocultarDivFast('tdImagen');mostrarDivFast('bverP'); ocultarDivFast('bocuP')"
                    var pVer = "mostrarDivFast('tdImagen');ocultarDivFast('bverP'); mostrarDivFast('bocuP')"

                    strhtml += '<div class="modal-header modal-header-danger" style="margin-top:0px;margin-bottom:0px;padding-top:2px;padding-bottom:2px;">'
                    strhtml += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                    strhtml += '<h5 class="modal-title" id="myModalLabel">'
                    strhtml += '<table style="border-bottom:0px;font-size:14px;width:100%;">'
                    strhtml += '<tr>'
                    strhtml += '<td style="font-size:14px;width:5%;text-align:left;">'
                    strhtml += '<span id="bocuP" onclick ="' + pOcu + '"  class="glyphicon glyphicon-eye-close"></span>'
                    strhtml += '<span id="bverP" onclick ="' + pVer + '" style="display:none" class="glyphicon glyphicon-picture"></span>'
                    strhtml += '</td>'
                    strhtml += '<td style="font-size:14px;width:90%;text-align:left;">Articulo:&nbsp;&nbsp;' + codArticulo + '&nbsp;&nbsp;-&nbsp;&nbsp;Precio:&nbsp;&nbsp;S/&nbsp;&nbsp;' + PrecioSinIgv + '</td>'
                    strhtml += '</tr>'
                    strhtml += '</table>'
                    strhtml += '</h5>'
                    strhtml += '</div>'
                    strhtml += '<div class="modal-body"><div class="table-responsive">'
                    strhtml += '<table id="example" class="table table-hover dataTable  table-striped table-responsive">'
                    strhtml += '<tbody>'
                    strhtml += '<tr>'
                    strhtml += '<td Id="tdImagen"style="background:#FFFFFF;width:30%;vertical-align:middle;border: 1px solid;border-color:gainsboro">'
                    strhtml += '<div Id="DivgImagen">'
                    strhtml += '<div id="DivNombre" style="text-align:center;"><h5><b>' + NombreArticulo + '</b></h5></div><br/>'
                    strhtml += '<div id="DivImagen" style="text-align:center;">'
                    strhtml += '<img id="imagenCatalogo" class="imgRedonda" src="' + strUrlImagen + '" width="100%" height="100%" />'
                    strhtml += '</div></div><br/>'
                    strhtml += '<div id="DivPrecio" style="text-align:left"><table style="width:100%" ><tr><td style="width:50%" ><div style="width:100%" ><h5><b>Precio:&nbsp;&nbsp;</b></h5></div></td><td><div style="width:100%;color:#FF0000"><h5><b>S/&nbsp;&nbsp;' + PrecioSinIgv + '</b></h5></div></td></tr></table></div>'
                    strhtml += '<div id="DivMarca" style="text-align:left"><h5><b>Marca:&nbsp;&nbsp;</b>' + MarcaArticulo + '</h5></div>'
                    strhtml += '<div id="DivColor" style="text-align:left"><h5><b>Color:&nbsp;&nbsp;</b>' + ColorArticulo + '</h5></div>'
                    strhtml += '<div id="DivCateg" style="text-align:left"><h5><b>Categorización:</b></h5></div>'

                    strhtml += '</div>'
                    strhtml += '</td>'
                    strhtml += '<td>'
                    strhtml += '<div id="listTalla" style="overflow-x: hidden; overflow-y:auto; height: 378px;">'
                    strhtml += divFinal
                    strhtml += '</div>'
                    strhtml += '</td>'
                    strhtml += '</tr>'
                    strhtml += '</tbody>'
                    strhtml += '</table>'
                    strhtml += '</div>'
                    strhtml += '<div class="modal-footer" style="margin-top:-30px">'
                    strhtml += '<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>'
                    strhtml += '</div>'
                    var options = { "backdrop": "static", keyboard: true };

                    $('#myModalContent').html(strhtml);
                    $('#myModal').modal(options);
                    $('#myModal').modal('show');
                    $('#myModal').on('shown.bs.modal', function (event) {
                        waitingDialog.hide();
                    })
                },
                error: function (xhr) {
                    waitingDialog.hide();
                    toastr.error(xhr, 'Mensaje');
                }
            });
        }

        function restarCantidad(control) {

            var Cod = control.getAttribute('data-id');
            var cInput = 'inpt_' + Cod;
            var valor = $('#' + cInput).val();
            var valorInt = 0;
            var msjAlert = "";
            valorInt = ((BorrarEspacio(valor) == '') ? (msjAlert += 'Fecha Nacimiento.<br/>', 0) : parseInt(valor) - 1);
            valorInt = ((valorInt <= 0) ? (0) : valorInt);
            $('#' + cInput).val(valorInt);
        }

        function validarStock(control) {

            var cInput = control.getAttribute('Id');
            var valor = (($('#' + cInput).val() == '') ? (0) : parseInt($('#' + cInput).val()));;
            var stock = parseInt(control.getAttribute('data-id'));
            if (valor > stock) {
                //$('#' + cInput).val(stock);
                toastr.error("Valor mayor que el Stock.", "Error");
            }
            if (valor < 0) { $('#' + cInput).val(0); toastr.error("Valor menor que cero.", "Error"); }

        }

        function ocultarDiv(divId) {

            $("#" + divId).hide("slow");
        }

        function mostrarDiv(divId) {

            $("#" + divId).show("slow");
        }

        function ocultarDivFast(divId) {

            $("#" + divId).hide();
        }

        function mostrarDivFast(divId) {

            $("#" + divId).show();
        }

        function BorrarEspacio(cadena) {
            cadena = cadena.replace(/ /g, "")
            return cadena;
        }

        //LIQUIDACION DEL PEDIDO

        function PrepararPedido() {


            var OrderDTL = {
                _code: '',
                _artName: '',
                _brand: '',//marca
                _brandImg: '',
                _color: '',
                _size: '',
                _qty: 0,
                _qtyCancel: 0,
                _majorCat: '',
                _cat: '',
                _subcat: '',
                _origin: '',
                _originDesc: '',
                _comm: '',
                _uriPhoto: '',
                _price: 0.00,
                _priceigv: 0.00,
                _priceDesc: '',
                _priceigvDesc: '',
                _commission: 0.00,
                _commissionigv: 0.00,
                _det_dcto_sigv: 0.00,
                _commissionPctg: 0.00,
                _commissionDesc: '',
                _commissionigvDesc: '',
                _dscto: 0.00,
                _dsctoDesc: '',
                _dsctoPerc: 0.00,
                _dsctoVale: 0.00,
                _dsctoValeDesc: '',
                _dsctoMsg: '',
                _lineTotal: 0.00,
                _lineTotDesc: '',
                _ap_percepcion: '',
                _ofe_Tipo: '',
                _ofe_PrecioPack: 0.00,
                _ofe_id: 0.00,
                _ofe_maxpares: 0.00,
                _ofe_porc: 0.00,
                _units: 0,
                _premio: '',
                _premioDesc: '',
                _premId: ''
            }

            //var orderDtlTemp={
            //    articulo:'',
            //    cantidad:0,
            //    items: 0,
            //    premId: null,
            //    premio: "N",
            //    talla:""
            //}glistOtderDtl

            glistOtderDtlTem = [];
            glistOtderDtl = [];

            var CantidadTotal = 0;
            var subTOTAL = 0.00
            var porcComision = gCustomer.comision / 100;
            var ComisionSum = 0.00;
            var nroItem = 0;
            for (var i = 0; i < listArticulos.length; i++) {

                var LinecantTotal = 0;
                var articulo = listArticulos[i].codigoArt;
                var PrecioArt = listArticulos[i].PrecioArt;
                var listTallasCantidad = listArticulos[i].listTallas;
                var ofe_Id = listArticulos[i].Ofe_Id;
                var Ofe_MaxPares = listArticulos[i].Ofe_MaxPares;
                var Ofe_Porc = listArticulos[i].Ofe_Porc;
                var Ofe_ArtVenta = listArticulos[i].Ofe_ArtVenta;
                //alert(PrecioArt)
                var nombreArticulo = listArticulos[i].DescriArt;
                var marca = listArticulos[i].MarcaArt;
                var color = listArticulos[i].ColorArt;
                var total = listArticulos[i].Total;

                for (var j = 0; j < listTallasCantidad.length; j++) {

                    nroItem++;

                    var CodTalla = listTallasCantidad[j].codTalla;
                    var Cantidad = parseInt(listTallasCantidad[j].CantTalla);
                    var comisionTalla = listTallasCantidad[j].comisionTalla;
                    var Comission = Math.round((((PrecioArt * Cantidad)) * porcComision) * 100) / 100;
                    var DescuentoTalla = listTallasCantidad[j].descuentoTalla;


                    var lineOrderDTL = {

                        _code: articulo,
                        _size: CodTalla,
                        _qty: Cantidad,
                        _price: PrecioArt,
                        _commissionPctg: porcComision,
                        _commission: Comission,
                        _ofe_porc: Ofe_Porc,
                        _dscto: DescuentoTalla,
                        _ofe_id: ofe_Id,
                        _premId: null,
                        _artName: nombreArticulo,
                        _brand: marca,
                        _color: color,
                        _lineTotal: total,
                    }

                    var orderDtlTemp = {
                        articulo: articulo,
                        cantidad: Cantidad,
                        items: nroItem,
                        premId: null,
                        premio: "N",
                        talla: CodTalla
                    }

                    glistOtderDtl.push(lineOrderDTL);
                    glistOtderDtlTem.push(orderDtlTemp);

                }

                //var Comission = ComisionSum;//(((PrecioArt * LinecantTotal)) * porcComision) * 1;
                //var desc = 0;

                //var comiss = Math.round(Comission * 100) / 100;
                //var Total = Math.round(((PrecioArt * LinecantTotal) - comiss - desc) * 100) / 100;

                //listArticulos[i].Comission = comiss;
                //listArticulos[i].listTallas = listTallasCantidad;
                //listArticulos[i].Total = Total;
                //listArticulos[i].Comission = comiss;
                //listArticulos[i].CantidadTotal = LinecantTotal;
                //subTOTAL += Total;
            }

        }

        function liquidarPedido() {
            PrepararPedido();
            //alert(glistOtderDtlTem[0].articulo);
            var formaPago = $('#dwFormaPago').val();

            var objPedidoLiquidar = {
                _usu: 5,
                _idCust: gCustomer.idCust,
                _reference: "",
                _discCommPctg: gCustomer.comision,//20
                _discCommValue: 0, //0
                _shipTo: "",//""
                _specialInstr: "",//""
                _itemsDetail: glistOtderDtl,// list _itemsDetail
                _varpercepcion: gMontoPercepcion,//0.80 monto de la percepcion
                _estado: gEstado,//1
                _ped_id: gPedId,//""
                _liq: gLiqId,//""
                _liq_dir: 0,//0
                _PagPos: 0,//0
                _PagoPostarjeta: "",//""
                _PagoNumConsignacion: "",//""
                _PagoTotal: 0,//0
                //dtpago: null,
                ListPago: glistPago,
                _pago_credito: false,//false
                _porc_percepcion: gCustomer.percepcion,//2
                order_dtl_temp: glistOtderDtlTem,
                strTipoPago: formaPago,//005 deposito banco
            }

            $.ajax
              ({
                  url: '../Pedido/LiquidarPedido',
                  dataType: "json",
                  type: "POST",
                  data: objPedidoLiquidar,
                  success: function (data, textStatus, XMLHttpRequest) {
                      waitingDialog.hide();

                      if ((data.Success).toString() == "true") {

                          if (gEstado == "1") {
                              toastr.success("Se liquidó el pedido con éxito. Nro: " + data.Message + ".", "Mensaje");
                              limpiarCampos();
                          }

                          if (gEstado == "2") {
                              toastr.success("Se modifico la liquidació con éxito. Nro: " + data.Message + ".", "Mensaje");

                          }



                      } else {
                          toastr.error("Se al liquidar el pedido.", "Error");
                      }

                  },
                  error: function (xhr) {
                      waitingDialog.hide();
                      toastr.error(xhr, 'Error Liquidar pedido');
                  }
              })

        }

        function limpiarCampos() {
            listArticulos = null;
            //DibujarGrilla();
        }
        //FIN LIQUIDACION DEL PEDIDO

        //FUNCIONES QUE PASAN CON UN DISPOSITIVO MOVIL


        function GrillaMovil() {


            var border2 = 'border:2px';
            var espacio = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
            var butonDelete = '<div class="col-sm-1" style="width:100%;margin-top:2px;margin-bottom:2px;">';
            butonDelete += ' <button title="Eliminar detalle" style="border-radius:50%" onclick="PopupEliminarTalla(this)" class="btnEliminar btn-xs btn-danger" data-id="valorArticuloDelete" data-modal="valorTallaDelete" data-toggle="modal"><span class="glyphicon glyphicon-remove" "></span></button>';
            butonDelete += '</div>';
            var strImg = '<td Id="tdImagenGR"style="background:#FFFFFF;width:20%;vertical-align:middle;">'
            strImg += '<div Id="DivgImagen">'
            strImg += '<div id="DivImagen" style="text-align:center;">'
            strImg += '<img id="imagenCatalogo" class="imgRedonda" src="DireccionImagen" width="100%" height="100%" />'
            strImg += '</div>'
            strImg += '</div>'
            strImg += '</td>'
            var css = 'class="row"';
            var ConstTalla = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-white btn-xs" style="width:100%;">variableTalla</button></div></td>'
            var BotonSuma = '<button title="Sumar Cantidad" class="btnSuma btn btn-white btn-xs" onclick="sumarCantidadMovil(this)" data-id="IdArticuloTallaS"  data-art="IdArticuloCodS" data-modal="Sstock" data-toggle="modal"><span class="glyphicon glyphicon-plus"></span></button>'
            var BotonResta = '<button title="Restar Cantidad" class="btnResta btn btn-white btn-xs" onclick="restarCantidadMovil(this)" data-id="IdArticuloTallaR" data-art="IdArticuloCodR" data-modal="Rstock" data-toggle="modal"><span class="glyphicon glyphicon-minus"></span></button>'
            var InputCantidadTalla = '<input id="inpArtTalla" type="Text"  value="valorInp" style="width:100%;" autofocus="" class="form-control"/>'
            var ConstHtmlDetalleTallas = '<br/><div id="listatallas" style="background:#FFFFFF;' + border2 + '" ><div ' + css + '  style="background:#FFFFFF;" ><div class="col-sm-12"><i class="fa fa-info-circle"></i>&nbsp;<b>Tallas y Cantidades</b><br/></div><div class="col-sm-12">ListaTallas</div><br/></div></div>';
            var ConstHtmlDetalle = '<div id="lugar" style="background:#FFFFFF;' + border2 + '" ><div ' + css + '  style="background:#FFFFFF;" ><div class="col-sm-12"><table style="width:100%;border: 1px solid;border-color:gainsboro"><tr><td>' + strImg + '</td><td><table style="width:100%">Nombre&nbsp;Codigo&nbsp;Marca&nbsp;Color&nbsp;Talla&nbsp;Precio&nbsp;CDantidad&nbsp;Cantidad</table></td></tr></table></div></div></div>';

            var strTablaTallas = '<table><tr><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-white btn-xs"  title="Tallas"  style="width:100%;">Tallas:</button></div></td><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-success btn-xs" style="width:100%;">Total</button></div></td>ListvariableTalla</tr><tr><td><div style="margin-top:2px;margin-right:2px;"><button  title="Cantidad"  class="btn btn-white btn-xs" style="width:100%;">Cantidad:</button></div></td></td><td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-success btn-xs" style="width:100%;">VTotal</button></div></td>ListvariableCantidad</tr></table>'
            var ConstTalla = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-primary btn-xs"  style="width:100%;" title="Talla"  data-id="codTienda" data-tda="desTiendaS" data-modal="codTalla" data-art="codArticulo"  >variableTalla</button></div></td>'
            var ConstCantidad = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-info btn-xs" style="width:100%;text-align:center;">variableCantidad</button></div></td>'

            var listTalla = '';
            var listCantidad = '';
            var divFinal = '';
            var strUrlImagen = '';
            var codTienda = ''
            var consTienda = ''
            var Precio = 0.00;
            var Comision = 0.00;
            var Descuento = 0.00;
            var Total = 0.00;
            var urlImagenSusti = '';
            var DireccionTienda = '';

            var cantidad = '';

            var NombreArticulo = '';
            var CodigoArt = '';
            var MarcaArticulo = '';
            var ColorArticulo = '';
            var CategoriArticulo = '';
            var PrecioSinIgv = '';
            var stock = '';
            var strhtmlF = ''
            var cant = 0;

            if (listArticulos != null) {

                $.each(listArticulos, function (index, item) {

                    cant += 1
                    CodigoArt = item.codigoArt;
                    strUrlImagen = item.strUrlImagen
                    NombreArticulo = item.DescriArt
                    MarcaArticulo = item.MarcaArt
                    ColorArticulo = item.ColorArt
                    PrecioSinIgv = item.PrecioArt
                    CategoriArticulo = item.Cat_Pri_Descripcion + ' > ' + item.Cat_Descripcion

                    var strhtml = ConstHtmlDetalle;
                    var strhtmlTallas = ConstHtmlDetalleTallas
                    //style = "font-size:14px;width:90%;text-align:left;"
                    var strIni = '<tr><td style="text-align:left;">&nbsp;<i class="fa fa-check-circle"></i>&nbsp;<b>';
                    var strIniCn = '<tr><td style="text-align:left;" colspan="2">&nbsp;<i class="fa fa-check-circle"></i>&nbsp;<b>';
                    var strIniS = '<tr><td style="text-align:left;"><b>';
                    var strIniNombre = '<tr><td style="text-align:center;" colspan="2" >&nbsp;&nbsp;<b>';
                    var strMedio = '</b></td><td valign="top" style="padding:0; margin:0;text-align:left;">&nbsp;&nbsp;'
                    var strMedioCant = '</b></td><td valign="top" style="padding:0; margin:0;text-align:center;">'
                    var strMedioPrecio = '</b></td><td valign="top" style="padding:0; margin:0;text-align:left;color:#FF0000;">&nbsp;&nbsp;'
                    var strFin = '</td></tr>';

                    var strNombre = strIniNombre + '' + '<b>' + NombreArticulo + strFin;
                    var strCodigo = strIniNombre + '' + '<b>' + CodigoArt + strFin;
                    var strMarca = strIni + 'Marca:' + strMedio + MarcaArticulo + strFin;
                    var strColor = strIni + 'Color:' + strMedio + ColorArticulo + strFin;
                    var strPrecio = strIni + 'Precio:' + strMedioPrecio + 'S/.' + item.PrecioArt + strFin;



                    strhtml = strhtml.replace("Nombre", strNombre);
                    strhtml = strhtml.replace("Codigo", strCodigo);

                    strhtml = strhtml.replace("Marca", strMarca);
                    strhtml = strhtml.replace("Color", strColor);
                    strhtml = strhtml.replace("Precio", strPrecio);
                    //strhtml = strhtml.replace("Talla", strTalla);
                    //strhtml = strhtml.replace("Cantidad", strCantidad);
                    strhtml = strhtml.replace("DireccionImagen", strUrlImagen);

                    var listTallasCantidad2 = item.listTallas;
                    var total = 0;



                    for (var j = 0; j < listTallasCantidad2.length; j++) {

                        var strhtmlTotal = strhtml;
                        var CodTalla = listTallasCantidad2[j].codTalla;

                        var strTalla = strIni + 'Talla:' + strMedio + CodTalla + strFin;
                        strhtmlTotal = strhtmlTotal.replace("Talla", strTalla);

                        var stock = listTallasCantidad2[j].stockTalla;

                        var strCantidad = strIniS + butonDelete + strMedioCant + '<table><tr><td>' + BotonResta + '</td><td width="50px"><div id="div_' + CodigoArt + '_' + CodTalla + '" >' + listTallasCantidad2[j].CantTalla + '</div><div style="display:none">' + InputCantidadTalla + '</div></td><td>' + BotonSuma + '</td></tr></table>' + strFin;
                        strhtmlTotal = strhtmlTotal.replace("Cantidad", strCantidad);

                        strhtmlTotal = strhtmlTotal.replace("inpArtTalla", "inpt_" + CodigoArt + '_' + CodTalla);
                        strhtmlTotal = strhtmlTotal.replace("valorInp", listTallasCantidad2[j].CantTalla);



                        strhtmlTotal = strhtmlTotal.replace("Sstock", stock);

                        strhtmlTotal = strhtmlTotal.replace("IdArticuloTallaS", CodTalla);
                        strhtmlTotal = strhtmlTotal.replace("IdArticuloTallaR", CodTalla);

                        strhtmlTotal = strhtmlTotal.replace("IdArticuloCodS", CodigoArt);
                        strhtmlTotal = strhtmlTotal.replace("IdArticuloCodR", CodigoArt);

                        strhtmlTotal = strhtmlTotal.replace("valorArticuloDelete", CodigoArt);//para el boton eliminar
                        strhtmlTotal = strhtmlTotal.replace("valorTallaDelete", CodTalla); //para le boton eliminar


                        var strDCantidad = strIniCn + 'Cantidad:' + '<b>' + strFin;
                        strhtmlTotal = strhtmlTotal.replace("CDantidad", strDCantidad);

                        divFinal += strhtmlTotal;
                    }

                })



                strhtmlF += '<div id="listTalla" style="overflow-x: hidden; overflow-y:auto;height:200px;">'
                strhtmlF += divFinal
                strhtmlF += '</div>'
            }
            if (cant > 0)
                document.getElementById("DivListCompra").innerHTML = strhtmlF;

            recalcularCostosArticulos();

        }

        function CantidadArticuloTalla(codigoArticulo, talla) {

            var cantidad = 0;

            for (var i = 0; i < listArticulos.length; i++) {

                if (codigoArticulo == listArticulos[i].codigoArt) {

                    var listTallasCantidad = listArticulos[i].listTallas;

                    for (var j = 0; j < listTallasCantidad.length; j++) {

                        var CodTalla = listTallasCantidad[j].codTalla;

                        if (talla == CodTalla) {

                            cantidad = listTallasCantidad[j].CantTalla;
                            break;
                        }

                    }

                    break;
                }
            }

            return cantidad;
        }

        function AsignarCantidadArticuloTalla(codigoArticulo, talla, cantidad) {

            var porcComision = gCustomer.comision / 100;

            var lineArticulo = {
                codigoArt: "",
                DescriArt: "",
                MarcaArt: "",
                ColorArt: "",
                PrecioArt: 0.00,
                listTallas: [],
                Comission: 0.00,
                Descuento: 0.00,
                Total: 0.00,
                CantidadTotal: 0,
                strUrlImagen: ""
            }

            var PrecioArt = 0.00;
            var LinecantTotal = 0;

            for (var i = 0; i < listArticulos.length; i++) {

                if (codigoArticulo == listArticulos[i].codigoArt) {

                    lineArticulo.codigoArt = listArticulos[i].codigoArt;
                    lineArticulo.DescriArt = listArticulos[i].DescriArt;
                    lineArticulo.MarcaArt = listArticulos[i].MarcaArt;
                    lineArticulo.ColorArt = listArticulos[i].ColorArt;
                    lineArticulo.strUrlImagen = listArticulos[i].strUrlImagen;

                    LinecantTotal = listArticulos[i].LinecantTotal;
                    PrecioArt = listArticulos[i].PrecioArt;

                    var listTallasCantidad = listArticulos[i].listTallas;

                    for (var j = 0; j < listTallasCantidad.length; j++) {

                        var CodTalla = listTallasCantidad[j].codTalla;

                        if (talla == CodTalla) {

                            var cantidadOld = listTallasCantidad[j].CantTalla;

                            listTallasCantidad[j].CantTalla = cantidad;

                            var ComissionT = (((PrecioArt * cantidad)) * porcComision) * 1;
                            var comisionTalla = Math.round(ComissionT * 100) / 100;

                            listTallasCantidad[j].comisionTalla = comisionTalla;



                            lineArticulo.listTallas = listTallasCantidad;

                            LinecantTotal = LinecantTotal + cantidad - cantidadOld;

                            lineArticulo.LinecantTotal = LinecantTotal;


                            listArticulos.splice(i, 1);

                            break;
                        }
                    }
                    break;
                }
            }


            var porcComision = gCustomer.comision / 100;
            var Comission = (((PrecioArt * LinecantTotal)) * porcComision) * 1;
            var desc = lineArticulo.Descuento
            var comiss = Math.round(Comission * 100) / 100;
            var Total = Math.round(((PrecioArt * LinecantTotal) - comiss - desc) * 100) / 100;

            lineArticulo.PrecioArt = PrecioArt;
            lineArticulo.Comission = comiss;
            lineArticulo.listTallas = listTallasCantidad;
            lineArticulo.Total = Total;
            lineArticulo.Comission = comiss;
            lineArticulo.CantidadTotal = LinecantTotal;
            listArticulos.push(lineArticulo);

        }

        function sumarCantidadMovil(control) {

            var codTalla = control.getAttribute('data-id');
            var codArticulo = control.getAttribute('data-art');
            var stock = parseInt(control.getAttribute('data-modal'));
            var cInput = 'inpt_' + codArticulo + '_' + codTalla;
            var valorActual = parseInt($('#' + cInput).val()) + 1;

            if (valorActual <= stock) {

                $('#' + cInput).val(valorActual);
                document.getElementById('div_' + codArticulo + '_' + codTalla).innerHTML = valorActual;
                AsignarCantidadArticuloTalla(codArticulo, codTalla, valorActual);
                recalcularCostosArticulos();

            } else {

                toastr.error("Cantidad no debe superar el stock:" + stock + ".", "Aviso");
            }
            //alert(CantidadArticuloTalla(codArticulo, codTalla))
            //var valorInt = 0;
            //var msjAlert = "";
            //valorInt = ((BorrarEspacio(valor) == '') ? (1) : parseInt(valor) + 1);
            //valorInt = ((valorInt >= stock) ? (stock) : valorInt);

            //$('#' + cInput).val(valorInt);
        }

        function restarCantidadMovil(control) {

            var codTalla = control.getAttribute('data-id');
            var codArticulo = control.getAttribute('data-art');
            var cInput = 'inpt_' + codArticulo + '_' + codTalla;
            var valorActual = parseInt($('#' + cInput).val()) - 1;

            if (valorActual >= 1) {
                $('#' + cInput).val(valorActual);
                document.getElementById('div_' + codArticulo + '_' + codTalla).innerHTML = valorActual;
                AsignarCantidadArticuloTalla(codArticulo, codTalla, valorActual);
                recalcularCostosArticulos();
            }
        }

        //FIN FUNCIONES QUE PASAN CON UN DISPOSITIVO MOVIL

        function ListarNotaCreditoParcial() {

            waitingDialog.show('Espere un momento por favor');
            var TeamDetailPostBackURL = "@Url.Action("ListaNC", "Pedido")";

            var $buttonClicked = $(this);

            var options = { "backdrop": "static", keyboard: true };
            $.ajax({
                type: "GET",
                url: TeamDetailPostBackURL,
                contentType: "application/json; charset=utf-8",
                data: { BasId: gCustomer.idCust, LiqId: '' },
                datatype: "json",
                cache: true,
                success: function (data) {
                    waitingDialog.hide();

                    //debugger;
                    $('#myModalContent').html(data);
                    $('#myModal').modal(options);
                    $('#myModal').modal('show');


                },
                error: function () {
                    waitingDialog.hide();
                    alert("Dynamic content load failed.");

                }
            })
        }

        /*Recuperar una liquidacion para su edicion */
        function getLiquidacion(IdLiquidacion) {

            gLiqId = IdLiquidacion;

            //waitingDialog.show('Espere un momento por favor');

            var ControllerUrl = "@Url.Action("getLiquidacionDetalle", "Pedido")";

            $.ajax({
                type: "GET",
                url: ControllerUrl,
                contentType: "application/json; charset=utf-8",
                data: { LiqId: IdLiquidacion },
                datatype: "json",
                cache: true,
                success: function (data) {

                    var codArticulo = '';
                    var dsctoTotal = 0.00;
                    var cantTotal = 0.00;
                    var comisionTotal = 0.00;
                    var listTallasCantidad = [];
                    var glineArticulo
                    var totalArticulo = 0.00;

                    $.each(data, function (index, item) {

                        codArticulo = ((codArticulo == '') ? (item._code) : codArticulo);

                        if (codArticulo != item._code) {

                            glineArticulo.listTallas = listTallasCantidad
                            glineArticulo.Comission = comisionTotal
                            glineArticulo.Descuento = dsctoTotal
                            glineArticulo.Total = totalArticulo
                            listTallasCantidad = [];
                            listArticulos.push(glineArticulo);
                            codArticulo = item._code;
                            cantTotal = 0.00;
                            dsctoTotal = 0.00;
                            comisionTotal = 0.00;
                            totalArticulo = 0.00;
                        }

                        glineArticulo = {
                            codigoArt: item._code,
                            DescriArt: item._artName,
                            MarcaArt: item._brand,
                            ColorArt: item._color,
                            PrecioArt: item._price,
                            AfecPercep: item._ap_percepcion,
                            Ofe_tipo: item._ofe_Tipo,
                            Ofe_Id: item._ofe_id,
                            Ofe_MaxPares: item._ofe_maxpares,
                            Ofe_Porc: item._ofe_porc,
                            Ofe_ArtVenta: item._ofe_PrecioPack,
                            listTallas: [],
                            Comission: 0.00,
                            Descuento: 0.00,
                            Total: item._code,
                            CantidadTotal: 0,
                            strUrlImagen: item._ArtImg,
                        }

                        var CostoTotal = Math.round((parseFloat(item._price) * parseFloat(item._qty)) * 100) / 100;
                        var TotalTalla = Math.round((CostoTotal - parseFloat(item._commission)) * 100) / 100;

                        cantTotal += cantTotal + parseInt(item._qty);
                        dsctoTotal += parseFloat(item._dscto);
                        comisionTotal += parseFloat(item._commission);
                        totalArticulo += TotalTalla;

                        var oTalla = {
                            Ofe_tipo: item._ofe_Tipo,
                            Ofe_Id: item._ofe_id,
                            Ofe_MaxPares: item._ofe_maxpares,
                            Ofe_Porc: item._ofe_porc,
                            Ofe_ArtVenta: item._ofe_PrecioPack,
                            codTalla: item._size,
                            CantTalla: item._qty,
                            stockTalla: item._Stkqty,
                            comisionTalla: item._commission,
                            descuentoTalla: item._dscto,
                            totalTalla: TotalTalla,
                        }



                        listTallasCantidad.push(oTalla);


                    });

                    glineArticulo.listTallas = listTallasCantidad
                    glineArticulo.Comission = comisionTotal
                    glineArticulo.Descuento = dsctoTotal
                    glineArticulo.Total = totalArticulo

                    listArticulos.push(glineArticulo);
                    validarOferta();
                    //DibujarGrilla();

                    waitingDialog.hide();
                },
                error: function () {
                    waitingDialog.hide();
                    alert('Error GetLiquidacion')
                }
            });

            waitingDialog.hide();
        }

        /*fin de recuperar una liquidacion para su edicion*/

        /*LISTA LAS NOTAS DE CREDITO PARA EL PAGO DE LA LIQUIDACION*/


        function ListarNotaCredito() {
            waitingDialog.show('Espere un momento por favor');

            var lBasId = gCustomer.idCust

            var css = 'class="row"'
            var border2 = 'padding: 5px 5px 5px 5px;border:2px'
            var espacio = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
            var ConstTalla = '<td><div style="margin-top:2px;margin-right:2px;"><button class="btn btn-white btn-xs" style="width:100%;">variableTalla</button></div></td>'
            var BotonSuma = '<button title="Sumar Cantidad" class="btnSuma btn btn-success" onclick="sumarCantidad(this)" data-id="IdArticuloTallaS" data-modal="Sstock" data-toggle="modal"><span class="glyphicon glyphicon-plus"></span></button>'
            var BotonResta = '<button title="Restar Cantidad" class="btnResta btn btn-danger" onclick="restarCantidad(this)" data-id="IdArticuloTallaR" data-modal="Rstock" data-toggle="modal"><span class="glyphicon glyphicon-minus"></span></button>'
            var InputCantidadTalla = '<input id="inpArtTalla" type="Text"  name="Talla" value="valor" placeholder="cantidad" onchange = "validarStock(this)" data-id="inpStock" style="width:100%;" autofocus="" class="form-control"/>'
            var ConstHtmlTienda = '<br/><div id="lugar" style="background:#FFFFFF;' + border2 + '" ><div ' + css + '  style="background:#FFFFFF;" ><div class="col-sm-12"><div><h4><strong>VariableTienda</strong></h4><p>&nbsp;DireccionTienda</p></div><table><tr><td><div style="margin-top:2px;">' + BotonResta + '</div></td><td style="width:100px"><div style="margin-top:2px;">' + InputCantidadTalla + '</div></td><td><div style="margin-top:2px;">' + BotonSuma + '</div></td></tr></table></div><br/></div></div>';
            var ConstCantidad = ''
            var listTalla = '';
            var listCantidad = '';
            var divFinal = '';
            var strUrlImagen = '';
            var options = { "backdrop": "static", keyboard: true };

            var ControllerUrl = "@Url.Action("getListaNC", "Pedido")";

            $.ajax({
                type: "GET",
                url: ControllerUrl,
                contentType: "application/json; charset=utf-8",
                data: { BasId: lBasId, LiqId: gLiqId },
                datatype: "json",
                cache: true,
                success: function (data) {

                    //$.each(data, function (index, item) {
                    //    alert(item.Ncredito)
                    //});

                    var style = 'style="background:#FFFFFF;width:30%;vertical-align:middle;border: 1px solid;border-color:gainsboro"';
                    var row = '<tr><td ' + style + '>valor1</td><td ' + style + ' >valor2</td><td ' + style + ' >valor3</td></tr>'
                    var strCheck = '<input type="checkbox" onchange="validarMontoNC(this)" id="IdNc" name="notaCredito" value="Bike">'
                    var strRowTotal = ''
                    var divGeneral = '<div id="IdMto" style="display:none;" >valorMto</div>'
                    var divList = ''
                    $.each(data, function (index, item) {
                        //alert(item.Ncredito)

                        strRowTotal += row;
                        strRowTotal = strRowTotal.replace("valor1", strCheck);
                        strRowTotal = strRowTotal.replace("IdNc", item.Rhv_return_nro);
                        strRowTotal = strRowTotal.replace("valor2", item.Ncredito);
                        strRowTotal = strRowTotal.replace("valor3", 'S/.' + item.Importe);
                        divList += divGeneral;
                        divList = divList.replace("IdMto", 'dm_' + item.Rhv_return_nro);
                        divList = divList.replace("valorMto", item.Importe);


                    });

                    var strhtml = ''

                    strhtml += '<div class="modal-header modal-header-danger" style="margin-top:0px;margin-bottom:0px;padding-top:2px;padding-bottom:2px;">'
                    strhtml += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                    strhtml += '<h5 class="modal-title" id="myModalLabel">'
                    strhtml += 'Seleccione nota de credito'
                    strhtml += '</h5>'
                    strhtml += '</div>'
                    strhtml += '<div class="modal-body">'
                    strhtml += '<table id="example" class="table table-hover dataTable  table-striped table-responsive">'
                    strhtml += '<tbody>'
                    strhtml += strRowTotal
                    strhtml += '</tbody>'
                    strhtml += '</table>'
                    strhtml += '</div>'
                    strhtml += '<div id="listadeNotas" style="display:none;" >'
                    strhtml += divList
                    strhtml += '</div>'
                    strhtml += '<div class="modal-footer" style="margin-top:-30px">'
                    strhtml += '<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>'
                    strhtml += '<input type="button" class="btn btn-primary" onclick="agregarNotaCredito()"   value="Agregar" />'
                    strhtml += '</div>'
                    var options = { "backdrop": "static", keyboard: true };

                    $('#myModalContent').html(strhtml);
                    $('#myModal').modal(options);
                    $('#myModal').modal('show');

                    waitingDialog.hide();
                },
                error: function () {
                    waitingDialog.hide();
                    alert('Error Listar Nota de Credito')
                }
            });

            waitingDialog.hide();
        }

        function agregarNotaCredito() {

            gvalorTotalCredito = 0.00;
            glistPago = [];

            $('input[name="notaCredito"]').each(function () {

                var Idnota = $(this).attr("id");

                if ($(this).is(':checked')) {
                    var valorNC = parseFloat(document.getElementById('dm_' + Idnota).innerHTML);

                    var objNc = {
                        numeroDoc: Idnota,
                        valorDoc: valorNC
                    }

                    gvalorTotalCredito += valorNC;
                    glistPago.push(objNc);
                }

            });
            recalcularCostosArticulos();
        }

        function validarMontoNC(control) {

            var ctrlId = $(control).attr("id");
            var montoTotalNC = 0.00;
            var bchekect

            $('input[name="notaCredito"]').each(function () {

                var Idnota = $(this).attr("id");

                if ($(this).is(':checked')) {

                    if (ctrlId != Idnota) {
                        var valorNC = parseFloat(document.getElementById('dm_' + Idnota).innerHTML);
                        montoTotalNC += valorNC
                    } else {

                    }

                }
            });

            if (montoTotalNC > gTotal) {
                document.getElementById(ctrlId).checked = false;
                toastr.error("No se puede seleccionar este registro, porque el total de saldos es mayor al total pedido.", "Error");

            }

        }


        /*FIN DEL LISTADO DE LAS NOTAS DE CREDITO*/





</script>
}
    